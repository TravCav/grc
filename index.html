<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CISO Navigator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --bg-alt: #020617;
      --card: #111827;
      --card-alt: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --danger: #f97373;
      --success: #34d399;
      --warning: #facc15;
      --radius-lg: 14px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #111827, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    .app-shell {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: linear-gradient(to bottom, #020617, #020617 40%, #020617);
      border-right: 1px solid rgba(148, 163, 184, 0.15);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .logo-orb {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 40%, #0f172a 75%);
      box-shadow:
        0 0 18px rgba(56, 189, 248, 0.7),
        0 0 50px rgba(8, 47, 73, 0.9);
    }

    .sidebar-title {
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .sidebar-sub {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .nav-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin: 14px 6px 4px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid transparent;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease,
        transform 0.08s ease;
      background: transparent;
    }

    .nav-item:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.3);
      color: var(--text);
      transform: translateY(-1px);
    }

    .nav-item.active {
      background: radial-gradient(circle at 0% 0%, #0ea5e9, #0369a1 55%, #020617 100%);
      color: #ecfeff;
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: 0 0 0 1px rgba(8, 47, 73, 0.9), 0 0 18px rgba(8, 47, 73, 0.9);
    }

    .nav-pill-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.4);
    }

    .nav-item.active .nav-dot {
      background: #fbbf24;
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.7);
    }

    .nav-tag {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--muted);
      border-top: 1px solid rgba(30, 64, 175, 0.6);
      padding-top: 10px;
    }

    .sidebar-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(129, 140, 248, 0.7);
      margin-bottom: 6px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .badge-pip {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
    }

    .main {
      flex: 1;
      padding: 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .breadcrumbs {
      font-size: 0.8rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .title {
      font-size: 1.6rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .title span.sub {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 400;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pill.highlight {
      border-color: rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
      background: rgba(8, 47, 73, 0.8);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.06), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(52, 211, 153, 0.06), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: 0;
    }

    .card-inner { position: relative; z-index: 1; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 0.83rem;
    }

    .metric-label { color: var(--muted); }
    .metric-value { font-weight: 600; }

    .metric-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.75rem;
      gap: 6px;
    }

    .sparkline {
      margin-top: 8px;
      height: 34px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      background: linear-gradient(to right, rgba(56, 189, 248, 0.1), transparent);
      position: relative;
      overflow: hidden;
    }

    .sparkline-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        to right,
        rgba(56, 189, 248, 0.5),
        rgba(129, 140, 248, 0.6),
        rgba(52, 211, 153, 0.5)
      );
      mask-image: linear-gradient(
        90deg,
        transparent 0%,
        #000 15%,
        #000 60%,
        transparent 100%
      );
      opacity: 0.7;
    }

    .split {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .list-item {
      background: rgba(15, 23, 42, 0.9);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px 9px;
      font-size: 0.86rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      transition: border-color 0.16s ease, transform 0.06s ease, background 0.16s ease;
    }

    .list-item:hover {
      border-color: rgba(56, 189, 248, 0.7);
      transform: translateY(-1px);
      background: radial-gradient(circle at top left, #0b1120, #020617 70%);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .badge.chip {
      border-color: rgba(56, 189, 248, 0.7);
      color: #e0f2fe;
      background: rgba(15, 23, 42, 0.9);
    }

    .detail-panel {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 10px 11px;
      font-size: 0.86rem;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.8);
    }

    .detail-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .detail-domain {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .detail-body {
      margin-top: 6px;
      line-height: 1.5;
      color: #e5e7eb;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .chip-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .chip-pill.em {
      border-color: rgba(234, 179, 8, 0.8);
      color: #facc15;
      background: rgba(24, 24, 27, 0.9);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .pill-stat {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      padding: 6px 10px;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pill-stat-label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.7rem;
    }

    .pill-stat-value { font-weight: 600; }
    .pill-stat-value.ok { color: var(--success); }
    .pill-stat-value.warn { color: var(--warning); }
    .pill-stat-value.bad { color: var(--danger); }

    .section-title {
      font-size: 0.98rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .section-note {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      margin-right: 4px;
      display: inline-block;
    }

    .tag-dot.warn { background: #facc15; }
    .tag-dot.bad { background: #f97373; }

    .heatmap-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }

    table.heatmap {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 520px;
    }

    table.heatmap th,
    table.heatmap td {
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 4px 6px;
      text-align: center;
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      white-space: nowrap;
    }

    table.heatmap th {
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    table.heatmap th:first-child {
      text-align: left;
      min-width: 160px;
      position: sticky;
      left: 0;
      z-index: 2;
    }

    table.heatmap td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      z-index: 1;
      background: rgba(15, 23, 42, 0.95);
    }

    .heatmap-cell-none {
      background: rgba(15, 23, 42, 0.9);
      color: rgba(148, 163, 184, 0.4);
    }

    .heatmap-cell-low {
      background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.9));
      color: #e0f2fe;
    }

    .heatmap-cell-med {
      background: radial-gradient(circle at 30% 0, rgba(129, 140, 248, 0.45), rgba(15, 23, 42, 0.9));
      color: #e0f2fe;
    }

    .heatmap-cell-high {
      background: radial-gradient(circle at 30% 0, rgba(52, 211, 153, 0.5), rgba(15, 23, 42, 0.9));
      color: #ecfdf5;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .form-input,
    .select-input,
    .textarea-input {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: var(--text);
      padding: 6px 8px;
      font-size: 0.8rem;
      min-width: 140px;
      flex: 1;
    }

    .primary-btn {
      margin-top: 8px;
      border-radius: 999px;
      padding: 6px 14px;
      border: none;
      background: linear-gradient(to right, #0ea5e9, #6366f1);
      color: white;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }

    .primary-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    /* CRUD controls */
    .action-row {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .action-link {
      font-size: 0.7rem;
      color: #93c5fd;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      text-decoration: underline;
    }

    .action-link.danger {
      color: #fca5a5;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .main { padding: 14px; }
      .grid, .split { grid-template-columns: 1fr; }
    }
  
    /* Modal */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(2,6,23,.72);
      display:none;align-items:center;justify-content:center;z-index:9999;
      padding:16px;
    }
    .modal-overlay.show{display:flex}
    .modal{
      width:min(720px, 96vw);
      background:radial-gradient(circle at top left,#111827 0,#020617 60%);
      border:1px solid rgba(56,189,248,.45);
      border-radius:var(--radius-lg);
      box-shadow:0 28px 70px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modal-header{
      padding:12px 14px;border-bottom:1px solid rgba(148,163,184,.18);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .modal-title{font-size:1.05rem;font-weight:650}
    .modal-subtitle{font-size:.8rem;color:var(--muted);margin-top:2px}
    .modal-close{
      border:none;background:transparent;color:var(--muted);
      font-size:1.2rem;cursor:pointer;line-height:1;padding:4px 8px;border-radius:10px;
    }
    .modal-close:hover{background:rgba(15,23,42,.9);color:var(--text)}
    .modal-body{padding:12px 14px}
    .modal-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .modal-grid.full{grid-template-columns:1fr}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.72rem;text-transform:uppercase;letter-spacing:.14em;color:var(--muted)}
    .field small{color:var(--muted);font-size:.78rem}
    .modal-actions{
      padding:12px 14px;border-top:1px solid rgba(148,163,184,.18);
      display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;padding:7px 14px;border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.92);color:var(--text);font-size:.85rem;cursor:pointer;
    }
    .btn:hover{border-color:rgba(56,189,248,.7)}
    .btn.primary{
      border:none;background:linear-gradient(to right,#0ea5e9,#6366f1);
    }
    .btn.danger{border-color:rgba(248,113,113,.55);color:#fecaca}

  </style>
</head>
<body>
<div class="app-shell">
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <div class="logo-orb"></div>
        <div>
          <div class="sidebar-title">CISO Navigator</div>
          <div class="sidebar-sub">Security Program OS</div>
        </div>
      </div>

      <div class="nav-section-title">Overview</div>
      <div class="nav-list">
        <button class="nav-item active" data-view="overview">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Program Overview</span>
          </span>
          <span class="nav-tag">LIVE</span>
        </button>
      </div>

      <div class="nav-section-title">Program</div>
      <div class="nav-list">
        <button class="nav-item" data-view="guided">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Guided Plan</span>
          </span>
          <span class="nav-tag">Start Here</span>
        </button>
        <button class="nav-item" data-view="capabilities">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Capability Explorer</span>
          </span>
          <span class="nav-tag">Map</span>
        </button>
        <button class="nav-item" data-view="maturity">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Maturity Assessment</span>
          </span>
          <span class="nav-tag">0–5</span>
        </button>
        <button class="nav-item" data-view="projects">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Projects</span>
          </span>
          <span class="nav-tag">Epics</span>
        </button>
        <button class="nav-item" data-view="roadmap">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Roadmap</span>
          </span>
          <span class="nav-tag">Work</span>
        </button>
      </div>

      <div class="nav-section-title">Tools & Ops</div>
      <div class="nav-list">
        <button class="nav-item" data-view="tools">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Tools & Platforms</span>
          </span>
          <span class="nav-tag">Inventory</span>
        </button>
        <button class="nav-item" data-view="heatmap">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Tool Heatmap</span>
          </span>
          <span class="nav-tag">Matrix</span>
        </button>
        <button class="nav-item" data-view="skills">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Skills & Coverage</span>
          </span>
          <span class="nav-tag">Team</span>
        </button>
        <button class="nav-item" data-view="ir">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>IR Hub</span>
          </span>
          <span class="nav-tag">IR</span>
        </button>
        <button class="nav-item" data-view="metrics">
          <span class="nav-pill-label">
            <span class="nav-dot"></span>
            <span>Metrics & Reporting</span>
          </span>
          <span class="nav-tag">EXCO</span>
        </button>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="sidebar-badge">
        <span class="badge-pip"></span>
        Small Team Mode
      </div>
      <div>Opinionated steps to build & mature your infosec program.</div>
      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px;">
        <button class="mini-btn" id="export-json-btn" type="button">Export JSON</button>
        <button class="mini-btn" id="import-json-btn" type="button">Import JSON</button>
        <button class="mini-btn" id="reset-data-btn" type="button" style="border-color:rgba(252,165,165,.55);">Reset</button>
      </div>
      <div style="margin-top:6px; font-size:.72rem; color:var(--muted);">Local only · share state via JSON</div>
    </div>
  </aside>

  <main class="main">
    <header class="top-bar">
      <div>
        <div class="breadcrumbs" id="breadcrumbs">PROGRAM ▸ OVERVIEW</div>
        <div class="title">
          <span id="view-title">Program Overview</span>
          <span class="sub" id="view-subtitle">High-level snapshot of your security program.</span>
        </div>
        <div class="pill-row">
          <span class="pill highlight">Guided for small teams</span>
          <span class="pill">NIST CSF</span>
          <span class="pill">Threat Detection</span>
          <span class="pill">IR & SOC</span>
          <span class="pill">GRC</span>
          <span class="pill">AI & GenAI</span>
        </div>
      </div>
    </header>

    <section id="view-container"></section>
  </main>
</div>

<script>

  // ---------- Utilities ------------------
  function escapeHtml(value) {
    const str = String(value ?? '');
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // ===== Tool × Capability helpers (0–5 maturity) =====
  function tcKey(toolId, capabilityId) {
    return (toolCapabilities || []).find(tc => tc.toolId === toolId && tc.capabilityId === capabilityId);
  }

  function hmClass(level) {
    const n = Math.max(0, Math.min(5, parseInt(level ?? 0, 10) || 0));
    return 'hm' + n;
  }


  // ===== Modal System =========================================
  const modalOverlayEl = document.getElementById('modal-overlay');
  const modalTitleEl = document.getElementById('modal-title');
  const modalSubtitleEl = document.getElementById('modal-subtitle');
  const modalBodyEl = document.getElementById('modal-body');
  const modalActionsEl = document.getElementById('modal-actions');
  const modalCloseEl = document.getElementById('modal-close');

  let _modalOnClose = null;

  function closeModal() {
    if (!modalOverlayEl) return;
    modalOverlayEl.classList.remove('show');
    document.body.style.overflow = '';
    modalTitleEl.textContent = 'Edit';
    modalSubtitleEl.textContent = '';
    modalBodyEl.innerHTML = '';
    modalActionsEl.innerHTML = '';
    const cb = _modalOnClose;
    _modalOnClose = null;
    if (typeof cb === 'function') {
      try { cb(); } catch (e) { console.warn('modal onClose error', e); }
    }
  }

  function openModal({ title='Edit', subtitle='', bodyHtml='', actions=[] , onClose=null }) {
    if (!modalOverlayEl) return;
    modalTitleEl.textContent = title || 'Edit';
    modalSubtitleEl.textContent = subtitle || '';
    modalBodyEl.innerHTML = bodyHtml || '';
    modalActionsEl.innerHTML = '';
    _modalOnClose = onClose;

    (actions || []).forEach(a => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = a.className || 'mini-btn';
      btn.textContent = a.label || 'OK';
      btn.addEventListener('click', () => {
        try { a.onClick && a.onClick(); } catch (e) { console.warn('modal action error', e); }
      });
      modalActionsEl.appendChild(btn);
    });

    modalOverlayEl.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // modal close wiring
  modalCloseEl?.addEventListener('click', closeModal);
  modalOverlayEl?.addEventListener('click', (e) => {
    if (e.target === modalOverlayEl) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalOverlayEl?.classList.contains('show')) closeModal();
  });

  // ===== Tool × Capability Uplift Templates =====================
  function defaultUpliftStepsFor(level) {
    // Generic steps for moving up one maturity level; users can customize per tool/capability.
    const templates = {
      0: ['Enable capability / data source', 'Assign owner', 'Document basic workflow'],
      1: ['Make process repeatable', 'Add minimal documentation (SOP)', 'Identify metrics to measure'],
      2: ['Standardize configs / playbooks', 'Integrate with upstream/downstream tools', 'Define quality checks'],
      3: ['Measure outcomes (KPIs)', 'Tune regularly (cadence)', 'Run tabletop / validation'],
      4: ['Automate where safe', 'Continuous improvement loop', 'Quarterly review + evidence capture']
    };
    return (templates[level] || ['Define next uplift step']).slice();
  }

  function ensureUpliftFields(tc) {
    if (!tc) return;
    if (!Array.isArray(tc.upliftSteps)) tc.upliftSteps = defaultUpliftStepsFor(tc.currentMaturity || 0).map(s => ({ text: s, done: false }));
    if (!Array.isArray(tc.evidence)) tc.evidence = [];
    if (!Array.isArray(tc.assessmentNotes)) tc.assessmentNotes = [];
    if (typeof tc.assessedBy !== 'string') tc.assessedBy = '';
  }

  // ===== Import / Export =======================================
  function exportStateToJson() {
    const data = { version: 3, exportedAt: new Date().toISOString(), capabilities, tools, toolCapabilities, tasks, skills, metrics, irPlaybooks, projects };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ciso-navigator-export.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  }

  function importStateFromJson(rawText) {
    let data;
    try { data = JSON.parse(rawText); } catch (e) { alert('Invalid JSON'); return; }
    if (!data) return;

    openModal({
      title: 'Import JSON',
      subtitle: 'Choose merge or replace.',
      bodyHtml: `
        <div class="detail-panel">
          <div class="detail-title">Import options</div>
          <div class="detail-body">
            <div style="margin-top:8px;">Found keys: <span class="badge chip">${Object.keys(data).filter(k=>k!=='exportedAt').join(', ')}</span></div>
            <div style="margin-top:10px; font-size:.85rem; color:var(--muted);">Merge keeps your existing items and adds new ones (by id). Replace overwrites everything.</div>
          </div>
        </div>
      `,
      actions: [
        { label: 'Cancel', className:'mini-btn', onClick: closeModal },
        { label: 'Merge', className:'primary-btn', onClick: () => {
            mergeImportedData(data);
            closeModal();
            renderView(currentView || 'overview');
          } },
        { label: 'Replace', className:'mini-btn', onClick: () => {
            replaceImportedData(data);
            closeModal();
            renderView('overview');
          } }
      ]
    });
  }

  function mergeById(existingArr, incomingArr) {
    const map = new Map(existingArr.map(x => [x.id, x]));
    (incomingArr || []).forEach(it => {
      if (!it || !it.id) return;
      if (map.has(it.id)) {
        map.set(it.id, { ...map.get(it.id), ...it });
      } else {
        map.set(it.id, it);
      }
    });
    return Array.from(map.values());
  }

  function mergeImportedData(data) {
    if (Array.isArray(data.capabilities)) capabilities = mergeById(capabilities, data.capabilities);
    if (Array.isArray(data.tools)) tools = mergeById(tools, data.tools);
    if (Array.isArray(data.toolCapabilities)) toolCapabilities = mergeById(toolCapabilities, data.toolCapabilities);
    if (Array.isArray(data.tasks)) tasks = mergeById(tasks, data.tasks);
    if (Array.isArray(data.skills)) skills = data.skills;
    if (Array.isArray(data.metrics)) metrics = data.metrics;
    if (Array.isArray(data.irPlaybooks)) irPlaybooks = data.irPlaybooks;
    if (Array.isArray(data.projects)) projects = mergeById(projects, data.projects);
    saveState();
  }

  function replaceImportedData(data) {
    if (Array.isArray(data.capabilities)) capabilities = data.capabilities;
    if (Array.isArray(data.tools)) tools = data.tools;
    if (Array.isArray(data.toolCapabilities)) toolCapabilities = data.toolCapabilities;
    if (Array.isArray(data.tasks)) tasks = data.tasks;
    if (Array.isArray(data.skills)) skills = data.skills;
    if (Array.isArray(data.metrics)) metrics = data.metrics;
    if (Array.isArray(data.irPlaybooks)) irPlaybooks = data.irPlaybooks;
    if (Array.isArray(data.projects)) projects = data.projects;
    saveState();
  }

  function resetAllData() {
    if (!confirm('Reset all data (clears local state)?')) return;
    localStorage.removeItem('cisoNavigatorDataV2');
    location.reload();
  }

  // wire sidebar buttons
  document.getElementById('export-json-btn')?.addEventListener('click', exportStateToJson);
  document.getElementById('import-json-btn')?.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.addEventListener('change', async () => {
      const file = input.files?.[0];
      if (!file) return;
      const text = await file.text();
      importStateFromJson(text);
    });
    input.click();
  });
  document.getElementById('reset-data-btn')?.addEventListener('click', resetAllData);

  // ===== Overlap / Consolidation Insights =======================
  function computeOverlapInsights() {
    const capToTools = new Map();
    toolCapabilities.forEach(tc => {
      if (!tc.capabilityId || !tc.toolId) return;
      if (!capToTools.has(tc.capabilityId)) capToTools.set(tc.capabilityId, []);
      capToTools.get(tc.capabilityId).push(tc);
    });

    const overlaps = [];
    const missing = [];

    capabilities.forEach(cap => {
      const rows = capToTools.get(cap.id) || [];
      if (rows.length === 0) {
        missing.push({ cap });
        return;
      }
      if (rows.length >= 2) {
        const avg = rows.reduce((s,r)=>s+(r.currentMaturity||0),0)/rows.length;
        overlaps.push({ cap, rows, avg });
      }
    });

    const weakOverlaps = overlaps.filter(o => o.avg <= 1.2);
    return { overlaps, weakOverlaps, missing };
  }

  // ===== Heatmap Drilldown Modal ================================
  function openToolCapabilityModal(toolId, capabilityId) {
    const tool = tools.find(t=>t.id===toolId);
    const cap = capabilities.find(c=>c.id===capabilityId);
    const tc = ensureToolCapability(toolId, capabilityId);
    ensureUpliftFields(tc);

    const stepsHtml = (tc.upliftSteps||[]).map((s,i)=>`
      <label style="display:flex; gap:8px; align-items:flex-start; margin:6px 0;">
        <input type="checkbox" data-step-index="${i}" ${s.done?'checked':''} />
        <span>${escapeHtml(s.text)}</span>
      </label>
    `).join('');

    openModal({
      title: 'Tool × Capability',
      subtitle: `${tool?.name || toolId} → ${cap?.name || capabilityId}`,
      bodyHtml: `
        <div class="detail-panel">
          <div class="detail-title">Maturity</div>
          <div class="form-row">
            <select class="select-input" id="tc-current">
              ${[0,1,2,3,4,5].map(n=>`<option value="${n}" ${n===(tc.currentMaturity||0)?'selected':''}>${n}</option>`).join('')}
            </select>
            <select class="select-input" id="tc-target">
              ${[0,1,2,3,4,5].map(n=>`<option value="${n}" ${n===(tc.targetMaturity??3)?'selected':''}>Target ${n}</option>`).join('')}
            </select>
          </div>
          <div class="form-row">
            <input class="form-input" id="tc-assessedby" placeholder="Assessed by" value="${escapeHtml(tc.assessedBy||'')}" />
            <input class="form-input" id="tc-reviewed" placeholder="Last reviewed" value="${escapeHtml(tc.lastReviewed||'')}" />
          </div>
          <div class="section-note">Notes</div>
          <textarea class="textarea-input" id="tc-notes" rows="3" placeholder="Notes...">${escapeHtml(tc.notes||'')}</textarea>
        </div>

        <div class="detail-panel" style="margin-top:10px;">
          <div class="detail-title">Uplift plan</div>
          <div class="section-note">Checklist to move this capability up one level.</div>
          <div id="tc-steps">
            ${stepsHtml || '<div class="section-note">No steps yet.</div>'}
          </div>
          <div class="form-row" style="margin-top:8px;">
            <input class="form-input" id="tc-newstep" placeholder="Add a step..." />
            <button class="mini-btn" type="button" id="tc-addstep">Add</button>
          </div>
        </div>

        <div class="detail-panel" style="margin-top:10px;">
          <div class="detail-title">Evidence</div>
          <div class="section-note">One per line (links, detection IDs, SOP names, tabletop date, etc.).</div>
          <textarea class="textarea-input" id="tc-evidence" rows="3" placeholder="Evidence...">${escapeHtml((tc.evidence||[]).join('\n'))}</textarea>
        </div>

        <div class="detail-panel" style="margin-top:10px;">
          <div class="detail-title">Assessment note</div>
          <div class="section-note">Add a short note when you change maturity (why / what changed).</div>
          <textarea class="textarea-input" id="tc-assessnote" rows="2" placeholder="e.g., Onboarded VPN logs + added 3 detections + weekly tuning cadence"></textarea>
        </div>
      `,
      actions: [
        { label:'Close', className:'mini-btn', onClick: closeModal },
        { label:'Create uplift task', className:'mini-btn', onClick: () => {
            const tool = tools.find(t=>t.id===toolId);
            const cap = capabilities.find(c=>c.id===capabilityId);
            const title = `Uplift ${cap?.name || capabilityId} in ${tool?.name || toolId} (+1 maturity)`;
            const newTask = {
              id: 't_' + Date.now(),
              title,
              capabilityId,
              toolId,
              status: 'Not Started',
              owner: 'Unassigned',
              impact: 'High',
              phase: 'Core',
              quarter: 'Core'
            };
            tasks.unshift(newTask);
            saveState();
            closeModal();
            renderView('roadmap');
          } },
        { label:'Save', className:'primary-btn', onClick: () => {
            const cur = parseInt(document.getElementById('tc-current').value, 10);
            const tgt = parseInt(document.getElementById('tc-target').value, 10);
            tc.currentMaturity = Number.isNaN(cur)?0:cur;
            tc.targetMaturity = Number.isNaN(tgt)?3:tgt;
            tc.assessedBy = (document.getElementById('tc-assessedby').value || '').trim();
            tc.lastReviewed = (document.getElementById('tc-reviewed').value || new Date().toISOString().slice(0,10)).trim();
            tc.notes = document.getElementById('tc-notes').value || '';
            tc.evidence = (document.getElementById('tc-evidence').value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

            // steps
            const stepChecks = Array.from(document.querySelectorAll('#tc-steps input[type="checkbox"]'));
            stepChecks.forEach(cb => {
              const i = parseInt(cb.getAttribute('data-step-index'),10);
              if (Number.isNaN(i)) return;
              tc.upliftSteps[i].done = cb.checked;
            });

            // assessment note
            const an = (document.getElementById('tc-assessnote').value || '').trim();
            if (an) tc.assessmentNotes.unshift({ at: new Date().toISOString(), note: an, by: tc.assessedBy || '' });

            saveState();
            closeModal();
            renderView('heatmap');
          } }
      ],
      onClose: null
    });

    // step add handler
    document.getElementById('tc-addstep')?.addEventListener('click', () => {
      const v = (document.getElementById('tc-newstep').value || '').trim();
      if (!v) return;
      tc.upliftSteps.push({ text: v, done: false });
      document.getElementById('tc-newstep').value = '';
      // re-open (simple refresh)
      closeModal();
      openToolCapabilityModal(toolId, capabilityId);
    });
  }


  function ensureToolCapability(toolId, capabilityId) {
    let tc = tcKey(toolId, capabilityId);
    if (tc) return tc;
    tc = {
      id: 'tc_' + toolId + '_' + capabilityId + '_' + Date.now(),
      toolId,
      capabilityId,
      currentMaturity: 0,
      targetMaturity: 3,
      notes: '',
      lastReviewed: new Date().toISOString().slice(0, 10)
    };
    toolCapabilities.push(tc);
    if (typeof saveState === 'function') saveState();
    return tc;
  }

  function removeToolCapabilityRow(rowId) {
    toolCapabilities = (toolCapabilities || []).filter(tc => tc.id !== rowId);
    if (typeof saveState === 'function') saveState();
  }

  function cycleToolCapMaturity(rowId) {
    const tc = (toolCapabilities || []).find(x => x.id === rowId);
    if (!tc) return;
    tc.currentMaturity = ((tc.currentMaturity || 0) + 1) % 6; // 0–5
    tc.lastReviewed = new Date().toISOString().slice(0, 10);
    if (typeof saveState === 'function') saveState();
  }



  // ---------- Data ------------------

  let capabilities = [
    {
      id: 'siem',
      name: 'Log Analysis & SIEM',
      domain: 'Threat Detection',
      nist: ['Detect'],
      maturity: 2,
      description:
        'Centralize, normalize, and correlate logs from infrastructure, cloud, and applications to detect threats and anomalies.',
      tags: ['SIEM', 'Logging', 'Detection'],
      owner: 'Threat Detection Lead',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'assetmgmt',
      name: 'Asset Management',
      domain: 'Security Operations',
      nist: ['Identify'],
      maturity: 1,
      description:
        'Maintain a complete inventory of infrastructure, cloud, applications, data flows, and third-party assets to drive risk-based decisions.',
      tags: ['Inventory', 'Exposure'],
      owner: 'IT Ops / SecOps',
      targetMaturity: 3,
      timeframe: '12 months'
    },
    {
      id: 'vulnmgmt',
      name: 'Vulnerability Management',
      domain: 'Security Operations',
      nist: ['Identify', 'Protect'],
      maturity: 1,
      description:
        'Risk-based identification, prioritization, and remediation across OS, network devices, applications, databases, and cloud.',
      tags: ['Vulns', 'Risk-Based', 'EPSS'],
      owner: 'SecOps Lead',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'appsec',
      name: 'Application Security',
      domain: 'Security Operations',
      nist: ['Identify', 'Protect'],
      maturity: 1,
      description:
        'Secure development standards, code review, SAST/DAST, OSS/SBOM controls, API and supply chain security embedded in SDLC.',
      tags: ['SDLC', 'API', 'SBOM'],
      owner: 'AppSec Lead',
      targetMaturity: 4,
      timeframe: '18 months'
    },
    {
      id: 'endpoint',
      name: 'Endpoint & Network Protection',
      domain: 'Security Operations',
      nist: ['Protect'],
      maturity: 2,
      description:
        'Harden endpoints and network with EDR, anti-malware, IDS/IPS, content filtering, DLP, DNS security, and patching.',
      tags: ['EDR', 'DLP', 'Patching'],
      owner: 'SecOps',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'soar',
      name: 'SOAR Automation',
      domain: 'Incident Response',
      nist: ['Respond'],
      maturity: 1,
      description:
        'Automate enrichment, response, and collaboration for high-volume alerts using playbooks and integrations.',
      tags: ['Automation', 'Playbooks', 'Enrichment'],
      owner: 'SOC Manager',
      targetMaturity: 4,
      timeframe: '18 months'
    },
    {
      id: 'incident',
      name: 'Incident Management',
      domain: 'Incident Response',
      nist: ['Respond', 'Recover'],
      maturity: 1,
      description:
        'Documented IR playbooks, readiness assessments, forensics partners, ransomware BIAs, exercises, and post-incident reviews.',
      tags: ['IR', 'BC/DR', 'Forensics'],
      owner: 'IR Lead',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'governance',
      name: 'Governance & Policy',
      domain: 'GRC',
      nist: ['Identify', 'Protect'],
      maturity: 3,
      description:
        'Define, maintain, and socialize a governance model, roles, policies, and standards for the security program.',
      tags: ['Governance', 'Policy', 'Standards'],
      owner: 'CISO',
      targetMaturity: 4,
      timeframe: '9 months'
    },
    {
      id: 'risk',
      name: 'Risk Management & TPRM',
      domain: 'GRC',
      nist: ['Identify'],
      maturity: 1,
      description:
        'Ongoing risk assessments, centralized risk register, third-party risk automation, cyber risk quantification, and loss/fraud prevention.',
      tags: ['Risk', 'TPRM', 'CRQ'],
      owner: 'GRC Lead',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'data',
      name: 'Data Protection & Privacy',
      domain: 'GRC',
      nist: ['Protect', 'Detect'],
      maturity: 1,
      description:
        'Data discovery, classification, access control, DLP, encryption/masking, and privacy compliance (GDPR/CCPA/HIPAA).',
      tags: ['DLP', 'Encryption', 'Privacy'],
      owner: 'Data Governance',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'cloud',
      name: 'Cloud Security Posture Management',
      domain: 'Cloud Security',
      nist: ['Identify', 'Protect', 'Detect'],
      maturity: 2,
      description:
        'Continuously assess and remediate cloud configuration risk across accounts, subscriptions, and resource groups.',
      tags: ['CSPM', 'Cloud', 'Misconfigurations'],
      owner: 'Cloud Security Architect',
      targetMaturity: 4,
      timeframe: '15 months'
    },
    {
      id: 'automation',
      name: 'Automation & Analytics',
      domain: 'Ops',
      nist: ['Protect', 'Detect', 'Respond'],
      maturity: 1,
      description:
        'Automate patching, asset inventory, threat hunting, metrics, compliance checks, and incident response playbooks.',
      tags: ['Automation', 'SOAR', 'Metrics'],
      owner: 'SecOps / Eng',
      targetMaturity: 4,
      timeframe: '18 months'
    },
    {
      id: 'identity',
      name: 'Identity & Access Management',
      domain: 'Access',
      nist: ['Protect'],
      maturity: 2,
      description:
        'Unified identities, SSO/MFA, federation, RBAC, PAM, API secrets, password-less, and device identities tied to zero trust.',
      tags: ['IAM', 'MFA', 'PAM'],
      owner: 'IAM Lead',
      targetMaturity: 4,
      timeframe: '12 months'
    },
    {
      id: 'architecture',
      name: 'Security Architecture',
      domain: 'Architecture',
      nist: ['Protect', 'Detect'],
      maturity: 2,
      description:
        'Defense-in-depth, segmentation/microsegmentation, zero trust, SASE/SSE, secure enclaves, and resilient networking.',
      tags: ['Zero Trust', 'SASE', 'Segmentation'],
      owner: 'Security Architect',
      targetMaturity: 4,
      timeframe: '18 months'
    },
    {
      id: 'ot',
      name: 'OT / ICS Visibility',
      domain: 'OT / ICS',
      nist: ['Identify', 'Detect'],
      maturity: 1,
      description:
        'Establish asset discovery, network monitoring, and risk analysis across OT, ICS, and medical devices where applicable.',
      tags: ['OT', 'ICS', 'Visibility'],
      owner: 'OT Security Lead',
      targetMaturity: 3,
      timeframe: '24 months'
    },
    {
      id: 'ai',
      name: 'AI & GenAI Governance',
      domain: 'Emerging Tech',
      nist: ['Identify', 'Protect'],
      maturity: 1,
      description:
        'Define policies, guardrails, and technical controls for enterprise use of AI and GenAI, including data protection and model access.',
      tags: ['AI', 'GenAI', 'Governance'],
      owner: 'CISO / Data Governance',
      targetMaturity: 4,
      timeframe: '12 months'
    }
  ];

  const mindmapSections = [
    {
      title: 'Security Operations - Threat Prevention',
      nist: ['Identify', 'Protect'],
      focus: 'Baseline controls to reduce attack surface.',
      capabilityIds: ['assetmgmt', 'vulnmgmt', 'appsec', 'endpoint'],
      items: [
        {
          heading: 'Asset & Vulnerability Management',
          bullets: [
            'Inventory infra, cloud, apps, data flows, IoT/OT; classify and prioritize with risk/EPSS.',
            'Continuous/periodic discovery; validate fixes; measure baseline metrics.'
          ]
        },
        {
          heading: 'Application Security',
          bullets: [
            'Secure SDLC with standards, code review, SAST/DAST, OSS/SBOM controls, API and supply chain security.',
            'Threat modeling and change control integrated with project delivery.'
          ]
        },
        {
          heading: 'Endpoint / Network Controls',
          bullets: [
            'IDS/IPS, WAF, DLP, anti-malware, anti-spam, proxy/DNS filtering, hardening, patching, DDoS protection.',
            'Cloud misconfiguration testing, FIM, desktop security, encryption/PKI.'
          ]
        },
        {
          heading: 'Awareness & Health Checks',
          bullets: [
            'Awareness training, health checks, and hardened baselines for on-prem, cloud, mobile, and containers.'
          ]
        }
      ]
    },
    {
      title: 'Threat Detection',
      nist: ['Detect'],
      focus: 'Detect adversary behavior across environments.',
      capabilityIds: ['siem'],
      items: [
        {
          heading: 'Detection Engineering',
          bullets: [
            'SIEM log analysis/correlation, alerting, NetFlow, packet inspection, misconfiguration detection, DLP signals.',
            'Deception tech, UEBA, anomaly detection, and integrations with cloud telemetry.'
          ]
        },
        {
          heading: 'SOC Operations',
          bullets: [
            'Staffing, shift/runbooks, metrics and reporting, DR exercises, MSSP integration, ISAC partnerships.',
            'Continuous training and tech stack management.'
          ]
        },
        {
          heading: 'Threat Hunting & Intel',
          bullets: [
            'Hunting and insider threat, TIP integration, MITRE ATT&CK mapping, long-term trend analysis.'
          ]
        }
      ]
    },
    {
      title: 'Incident Management',
      nist: ['Respond', 'Recover'],
      focus: 'Preparedness, response, and recovery.',
      capabilityIds: ['incident', 'soar'],
      items: [
        {
          heading: 'Readiness & Playbooks',
          bullets: [
            'Documented playbooks, IR plan, leadership expectations, first responder training, media relations.',
            'Forensics partner/retainer, adequate logging, simulations/tabletops.'
          ]
        },
        {
          heading: 'Ransomware & Crisis',
          bullets: [
            'Critical system BIA, containment strategy, offline backups, backup testing, integrity checking, crisis comms.'
          ]
        },
        {
          heading: 'Automation & Supply Chain',
          bullets: [
            'SOAR playbooks, machine integrity checking, supply-chain incident mgmt, post-incident analysis, cyber risk insurance.'
          ]
        }
      ]
    },
    {
      title: 'Identity & Access Management',
      nist: ['Protect'],
      focus: 'Unified identities and least privilege.',
      capabilityIds: ['identity'],
      items: [
        {
          heading: 'Identity Fabric',
          bullets: [
            'Credentialing, lifecycle, SSO/MFA, federation (SAML/OIDC), unified profiles, cloud/IoT device identities.',
            'Password resets/self-service, HR integration, customer identity, SaaS IAM.'
          ]
        },
        {
          heading: 'Zero Trust & Privileged Access',
          bullets: [
            'RBAC/ABAC, PAM, password-less, passkeys, biometrics, voice/face signatures.',
            'API authentication and secrets management, OAuth, secure tokens.'
          ]
        }
      ]
    },
    {
      title: 'Governance, Risk, Compliance',
      nist: ['Identify', 'Protect', 'Detect'],
      focus: 'Align security with business, privacy, and law.',
      capabilityIds: ['governance', 'risk', 'data'],
      items: [
        {
          heading: 'Strategy & Oversight',
          bullets: [
            'Business alignment, policies/standards, roles (RACI), board oversight, roadmap 1-3 years.',
            'Frameworks (NIST/ISO/COBIT/FAIR/CMMC), control effectiveness, consolidation choices.'
          ]
        },
        {
          heading: 'Risk & Data',
          bullets: [
            'Risk assessments, pentesting, risk register, phishing/awareness, TPRM automation, CRQ.',
            'Data ownership, discovery, classification, sharing/privacy, retention/destruction.'
          ]
        },
        {
          heading: 'Compliance & Legal',
          bullets: [
            'Privacy laws (GDPR/CCPA/HIPAA), PCI/SOX, SSAE18, FISMA, DORA, incident notifications, investigations/forensics.'
          ]
        }
      ]
    },
    {
      title: 'Security Architecture & Engineering',
      nist: ['Protect', 'Detect'],
      focus: 'Design for resilience and segmentation.',
      capabilityIds: ['architecture', 'automation'],
      items: [
        {
          heading: 'Architecture Patterns',
          bullets: [
            'Network segmentation/microsegmentation, zero trust roadmap, SASE/SSE, overlay networks, secure enclaves.',
            'Resilient remote access, encryption, backup/replication, software-defined networking.'
          ]
        },
        {
          heading: 'Delivery Lifecycle',
          bullets: [
            'Embed security in requirements/design reviews, threat modeling, testing, certification/accreditation, DevSecOps.'
          ]
        }
      ]
    },
    {
      title: 'Cloud & SaaS',
      nist: ['Identify', 'Protect', 'Detect'],
      focus: 'Cloud posture, SaaS due diligence, and logging.',
      capabilityIds: ['cloud'],
      items: [
        {
          heading: 'Strategy & Posture',
          bullets: [
            'Multi-cloud strategy, CSPM/CNAPP, ownership/liability clarity, incident processes, DR posture.',
            'Data ownership/compliance, vendor SLAs and financial strength.'
          ]
        },
        {
          heading: 'Integration & Controls',
          bullets: [
            'Identity federation/SSO, cloud log ingestion/APIs, virtualized security appliances, cloud-native app security.',
            'Containers/serverless/service mesh security, SaaS policy and guidelines.'
          ]
        }
      ]
    },
    {
      title: 'Data, OT/IoT, and Emerging Tech',
      nist: ['Identify', 'Protect', 'Detect'],
      focus: 'Protect data everywhere, including physical and OT.',
      capabilityIds: ['data', 'ot'],
      items: [
        {
          heading: 'Data-Centric Controls',
          bullets: [
            'Discovery, classification, access control, DLP, masking/encryption, monitoring and alerting.'
          ]
        },
        {
          heading: 'OT / IoT',
          bullets: [
            'IoT frameworks, device identity/auth/integrity, OTA updates, protocol coverage, visibility and monitoring.',
            'Use cases: smart grid, smart cities, condition-based monitoring, AR/VR, drones, edge.'
          ]
        }
      ]
    },
    {
      title: 'Artificial Intelligence & GenAI',
      nist: ['Identify', 'Protect'],
      focus: 'Safe, ethical, and secure AI adoption.',
      capabilityIds: ['ai'],
      items: [
        {
          heading: 'Governance & Safety',
          bullets: [
            'Policies, transparency, safe/ethical use, protecting IP and data, secure models, adversarial attack defenses.',
            'NIST AI RMF, OWASP LLM/GenAI risks, GenAI testing tools.'
          ]
        },
        {
          heading: 'Enablement',
          bullets: [
            'Use of AI/GenAI for automation, detection, analytics; RAG/agents/chatbots; train security teams on AI.'
          ]
        }
      ]
    },
    {
      title: 'Business Enablement & Team',
      nist: ['Identify', 'Protect'],
      focus: 'Security as a business partner.',
      capabilityIds: ['governance', 'risk'],
      items: [
        {
          heading: 'M&A and Partnerships',
          bullets: [
            'Acquisition risk assessments, integration costs, IAM and tooling rationalization, network/app/cloud integration.'
          ]
        },
        {
          heading: 'People and Budget',
          bullets: [
            'Budgeting (CapEx/OpEx), staffing and retention, burnout prevention, training, outsourcing/consulting balance.'
          ]
        }
      ]
    }
  ];

  let tools = [
    {
      id: 'tool_siem',
      name: 'Splunk Enterprise Security',
      vendor: 'Splunk',
      category: 'SIEM',
      capabilities: ['siem'],
      currentLevel: 2,
      targetLevel: 3,
      currentUse: [
        'Collects auth / VPN / firewall logs',
        'Basic correlation searches for failed logins'
      ],
      potentialUse: [
        'Risk-based alerting on users and assets',
        'Detection engineering mapped to MITRE ATT&CK',
        'Dashboards for executives and product teams'
      ]
    },
    {
      id: 'tool_edr',
      name: 'CrowdStrike Falcon',
      vendor: 'CrowdStrike',
      category: 'EDR / XDR',
      capabilities: ['siem', 'soar'],
      currentLevel: 2,
      targetLevel: 3,
      currentUse: [
        'Installed on servers and endpoints',
        'Alerts manually triaged in console'
      ],
      potentialUse: [
        'Tuned detection policies for critical assets',
        'Integrated with SIEM / SOAR for auto-enrichment',
        'Containment playbooks for high-severity alerts'
      ]
    },
    {
      id: 'tool_soar',
      name: 'TheHive + Cortex',
      vendor: 'Open Source',
      category: 'SOAR / Case Management',
      capabilities: ['soar'],
      currentLevel: 1,
      targetLevel: 3,
      currentUse: [
        'Used as ticketing for investigations',
        'Manual note-taking for major incidents'
      ],
      potentialUse: [
        'Standardized case templates per incident type',
        'Automated enrichment via analyzers',
        'Metrics on MTTR, case volume, and automation'
      ]
    },
    {
      id: 'tool_cspm',
      name: 'Prisma Cloud',
      vendor: 'Palo Alto Networks',
      category: 'CSPM / CNAPP',
      capabilities: ['cloud'],
      currentLevel: 1,
      targetLevel: 3,
      currentUse: [
        'Basic misconfiguration alerts for one cloud environment'
      ],
      potentialUse: [
        'Policy-as-code for multiple environments',
        'Risk-based view combining vulnerabilities + exposure',
        'Guardrails for dev teams in CI/CD'
      ]
    },
    {
      id: 'tool_ot',
      name: 'Claroty xDome',
      vendor: 'Claroty',
      category: 'OT / ICS Visibility',
      capabilities: ['ot'],
      currentLevel: 0,
      targetLevel: 2,
      currentUse: [
        'Planned pilot in one network segment'
      ],
      potentialUse: [
        'Baseline visibility for OT / IoMT assets',
        'Alerting on unusual network flows',
        'Support OT-specific IR scenarios'
      ]
    }
  ];

  // Tool × Capability maturity (0–5). One row per capability per tool.
  let toolCapabilities = [];


  let tasks = [
    {
      id: 't1',
      title: 'Create a one-page security charter and get leadership sign-off',
      capabilityId: 'governance',
      status: 'Not Started',
      owner: 'CISO / Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't2',
      title: 'Inventory top 10 critical systems and data flows',
      capabilityId: 'governance',
      status: 'Not Started',
      owner: 'Security + IT',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't3',
      title: 'Onboard priority log sources into SIEM (auth, VPN, critical apps)',
      capabilityId: 'siem',
      status: 'Not Started',
      owner: 'Threat Detection Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't4',
      title: 'Write and approve an Incident Response playbook for ransomware',
      capabilityId: 'soar',
      status: 'Not Started',
      owner: 'IR Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't5',
      title: 'Run a basic tabletop exercise using the ransomware playbook',
      capabilityId: 'soar',
      status: 'Not Started',
      owner: 'IR Lead',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    },
    {
      id: 't6',
      title: 'Turn phishing alerts into a repeatable SIEM detection + IR flow',
      capabilityId: 'siem',
      status: 'Not Started',
      owner: 'SOC / IR',
      quarter: 'Core',
      impact: 'High',
      phase: 'Core'
    },
    {
      id: 't7',
      title: 'Baseline cloud security posture (CSPM) for one cloud platform',
      capabilityId: 'cloud',
      status: 'Not Started',
      owner: 'Cloud Security',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    },
    {
      id: 't8',
      title: 'Publish AI & GenAI acceptable use and data handling rules',
      capabilityId: 'ai',
      status: 'Not Started',
      owner: 'CISO',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    },
    {
      id: 't9',
      title: 'Automate enrichment for high-volume alerts (IP, hash, user context)',
      capabilityId: 'soar',
      status: 'Not Started',
      owner: 'SOC',
      quarter: 'Optimize',
      impact: 'Medium',
      phase: 'Optimize'
    },
    {
      id: 't10',
      title: 'Formalize a recurring tabletop schedule (quarterly) with business',
      capabilityId: 'soar',
      status: 'Not Started',
      owner: 'IR Lead',
      quarter: 'Optimize',
      impact: 'Medium',
      phase: 'Optimize'
    },
    {
      id: 't11',
      title: 'Establish KPIs for detection, response, and patching',
      capabilityId: 'governance',
      status: 'Not Started',
      owner: 'CISO',
      quarter: 'Optimize',
      impact: 'Medium',
      phase: 'Optimize'
    },
    {
      id: 't12',
      title: 'Build authoritative asset inventory and classify critical systems',
      capabilityId: 'assetmgmt',
      status: 'Not Started',
      owner: 'SecOps / IT',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't13',
      title: 'Launch risk-based vulnerability management using EPSS and SLAs',
      capabilityId: 'vulnmgmt',
      status: 'Not Started',
      owner: 'SecOps Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't14',
      title: 'Embed secure SDLC controls (standards, SAST/DAST, SBOM, API security)',
      capabilityId: 'appsec',
      status: 'Not Started',
      owner: 'AppSec Lead',
      quarter: 'Core',
      impact: 'High',
      phase: 'Core'
    },
    {
      id: 't15',
      title: 'Harden endpoints and network (EDR, DLP, DNS filtering, patch automation)',
      capabilityId: 'endpoint',
      status: 'Not Started',
      owner: 'SecOps',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't16',
      title: 'Expand SIEM detections with UEBA, hunting, and cloud telemetry',
      capabilityId: 'siem',
      status: 'Not Started',
      owner: 'Threat Detection Lead',
      quarter: 'Core',
      impact: 'High',
      phase: 'Core'
    },
    {
      id: 't17',
      title: 'Standardize SOC runbooks, metrics, and DR exercises',
      capabilityId: 'siem',
      status: 'Not Started',
      owner: 'SOC Manager',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    },
    {
      id: 't18',
      title: 'Document IR playbooks and run ransomware tabletop',
      capabilityId: 'incident',
      status: 'Not Started',
      owner: 'IR Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't19',
      title: 'Build SOAR playbooks for enrichment and containment',
      capabilityId: 'soar',
      status: 'Not Started',
      owner: 'IR Lead',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    },
    {
      id: 't20',
      title: 'Roll out data discovery, classification, and DLP monitoring',
      capabilityId: 'data',
      status: 'Not Started',
      owner: 'Data Governance',
      quarter: 'Core',
      impact: 'High',
      phase: 'Core'
    },
    {
      id: 't21',
      title: 'Deploy SSO/MFA across workforce apps and establish PAM for admins',
      capabilityId: 'identity',
      status: 'Not Started',
      owner: 'IAM Lead',
      quarter: 'Foundation',
      impact: 'High',
      phase: 'Foundation'
    },
    {
      id: 't22',
      title: 'Design zero trust segmentation and SASE/SSE rollout plan',
      capabilityId: 'architecture',
      status: 'Not Started',
      owner: 'Security Architect',
      quarter: 'Optimize',
      impact: 'High',
      phase: 'Optimize'
    },
    {
      id: 't23',
      title: 'Enable CSPM for multi-cloud with policy-as-code and alert routing',
      capabilityId: 'cloud',
      status: 'Not Started',
      owner: 'Cloud Security Architect',
      quarter: 'Core',
      impact: 'High',
      phase: 'Core'
    },
    {
      id: 't24',
      title: 'Automate patching, compliance checks, and security metrics collection',
      capabilityId: 'automation',
      status: 'Not Started',
      owner: 'SecOps Engineering',
      quarter: 'Optimize',
      impact: 'Medium',
      phase: 'Optimize'
    },
    {
      id: 't25',
      title: 'Pilot OT/IoT visibility and anomaly detection in one segment',
      capabilityId: 'ot',
      status: 'Not Started',
      owner: 'OT Security Lead',
      quarter: 'Foundation',
      impact: 'Medium',
      phase: 'Foundation'
    },
    {
      id: 't26',
      title: 'Publish AI/GenAI policy, guardrails, and testing approach',
      capabilityId: 'ai',
      status: 'Not Started',
      owner: 'CISO',
      quarter: 'Foundation',
      impact: 'Medium',
      phase: 'Foundation'
    },
    {
      id: 't27',
      title: 'Centralize risk register and automate third-party risk intake',
      capabilityId: 'risk',
      status: 'Not Started',
      owner: 'GRC Lead',
      quarter: 'Core',
      impact: 'Medium',
      phase: 'Core'
    }
  ];

  let skills = [
    { person: 'SOC Analyst', skill: 'MITRE ATT&CK', level: 3, target: 4 },
    { person: 'SOC Analyst', skill: 'SIEM Engineering', level: 2, target: 4 },
    { person: 'IR Lead', skill: 'Incident Response', level: 4, target: 5 },
    { person: 'IR Lead', skill: 'Crisis Communications', level: 2, target: 4 },
    { person: 'Cloud Sec Eng', skill: 'Cloud Security (Azure/AWS)', level: 3, target: 4 },
    { person: 'OT Security', skill: 'OT / ICS Security', level: 2, target: 4 },
    { person: 'CISO', skill: 'Executive Storytelling', level: 4, target: 5 },
    { person: 'CISO', skill: 'AI / GenAI Strategy', level: 2, target: 4 }
  ];

  let metrics = [
    { name: 'Mean Time to Detect (MTTD)', value: '3.2 hours', trend: 'improving' },
    { name: 'Mean Time to Contain (MTTC)', value: '8.5 hours', trend: 'steady' },
    { name: 'Security automation coverage', value: '24%', trend: 'improving' },
    { name: 'Critical patch SLA met', value: '87%', trend: 'needs-attention' },
    { name: 'Phish click-rate', value: '4.1%', trend: 'improving' }
  ];

  let irPlaybooks = [
    {
      name: 'Ransomware Response',
      lastTested: '8 weeks ago',
      status: 'Needs Retest',
      owner: 'IR Lead'
    },
    {
      name: 'Business Email Compromise',
      lastTested: '2 weeks ago',
      status: 'Healthy',
      owner: 'SOC Manager'
    },
    {
      name: 'Cloud Account Compromise',
      lastTested: '16 weeks ago',
      status: 'Stale',
      owner: 'Cloud Security Architect'
    }
  ];

  // Projects
  let projects = [
    {
      id: 'proj_detection2',
      name: 'Threat Detection 2.0',
      capabilityId: 'siem',
      owner: 'Threat Detection Lead',
      start: '2025-01-01',
      target: '2025-06-30',
      maturityImpact: 2,
      taskIds: ['t3', 't6', 't16', 't17'],
      notes: 'Strengthen SIEM coverage and create end-to-end detection + IR flow.'
    },
    {
      id: 'proj_ir_modernization',
      name: 'IR Modernization',
      capabilityId: 'soar',
      owner: 'IR Lead',
      start: '2025-02-01',
      target: '2025-09-30',
      maturityImpact: 2,
      taskIds: ['t4', 't5', 't9', 't10'],
      notes: 'Standardize IR playbooks and build automation for high-volume events.'
    },
    {
      id: 'proj_ai_governance_mvp',
      name: 'AI Governance MVP',
      capabilityId: 'ai',
      owner: 'CISO',
      start: '2025-03-01',
      target: '2025-08-31',
      maturityImpact: 2,
      taskIds: ['t8', 't11', 't26'],
      notes: 'Baseline AI/GenAI usage, define guardrails, and measure adoption.'
    },
    {
      id: 'proj_asset_baseline',
      name: 'Asset Inventory Baseline',
      capabilityId: 'assetmgmt',
      owner: 'SecOps / IT',
      start: '2025-01-15',
      target: '2025-05-31',
      maturityImpact: 1,
      taskIds: ['t12'],
      notes: 'Authoritative inventory and classification for critical systems and data flows.'
    },
    {
      id: 'proj_vuln_risk_based',
      name: 'Risk-Based Vulnerability Mgmt',
      capabilityId: 'vulnmgmt',
      owner: 'SecOps Lead',
      start: '2025-02-01',
      target: '2025-06-30',
      maturityImpact: 2,
      taskIds: ['t13'],
      notes: 'Prioritize remediation using risk/EPSS and enforce SLAs.'
    },
    {
      id: 'proj_appsec_sdlc',
      name: 'Secure SDLC Controls',
      capabilityId: 'appsec',
      owner: 'AppSec Lead',
      start: '2025-03-01',
      target: '2025-09-30',
      maturityImpact: 2,
      taskIds: ['t14'],
      notes: 'Standards, SAST/DAST, SBOM, and API security embedded in delivery.'
    },
    {
      id: 'proj_endpoint_hardening',
      name: 'Endpoint & Network Hardening',
      capabilityId: 'endpoint',
      owner: 'SecOps',
      start: '2025-01-15',
      target: '2025-04-30',
      maturityImpact: 1,
      taskIds: ['t15'],
      notes: 'EDR, DLP, DNS filtering, and patch automation rollout.'
    },
    {
      id: 'proj_incident_ready',
      name: 'Incident Readiness',
      capabilityId: 'incident',
      owner: 'IR Lead',
      start: '2025-01-20',
      target: '2025-05-31',
      maturityImpact: 2,
      taskIds: ['t18'],
      notes: 'Playbooks, tabletop, and ransomware preparedness.'
    },
    {
      id: 'proj_soar_playbooks',
      name: 'SOAR Playbooks',
      capabilityId: 'soar',
      owner: 'IR Lead',
      start: '2025-02-15',
      target: '2025-07-31',
      maturityImpact: 1,
      taskIds: ['t19'],
      notes: 'Automated enrichment and containment flows.'
    },
    {
      id: 'proj_data_protection',
      name: 'Data Protection & Privacy',
      capabilityId: 'data',
      owner: 'Data Governance',
      start: '2025-03-15',
      target: '2025-09-15',
      maturityImpact: 2,
      taskIds: ['t20'],
      notes: 'Discovery, classification, and DLP monitoring for priority data.'
    },
    {
      id: 'proj_identity_zero_trust',
      name: 'Identity & Access Hardening',
      capabilityId: 'identity',
      owner: 'IAM Lead',
      start: '2025-01-10',
      target: '2025-06-30',
      maturityImpact: 2,
      taskIds: ['t21'],
      notes: 'SSO/MFA everywhere and PAM for admins.'
    },
    {
      id: 'proj_architecture_zero_trust',
      name: 'Zero Trust Architecture',
      capabilityId: 'architecture',
      owner: 'Security Architect',
      start: '2025-04-01',
      target: '2025-12-31',
      maturityImpact: 2,
      taskIds: ['t22'],
      notes: 'Segmentation and SASE/SSE roadmap with controls rollout.'
    },
    {
      id: 'proj_cloud_posture',
      name: 'Cloud Posture & CSPM',
      capabilityId: 'cloud',
      owner: 'Cloud Security Architect',
      start: '2025-02-01',
      target: '2025-07-31',
      maturityImpact: 1,
      taskIds: ['t23'],
      notes: 'Multi-cloud policy-as-code and alert routing.'
    },
    {
      id: 'proj_automation_metrics',
      name: 'Automation & Analytics',
      capabilityId: 'automation',
      owner: 'SecOps Engineering',
      start: '2025-06-01',
      target: '2025-12-31',
      maturityImpact: 1,
      taskIds: ['t24'],
      notes: 'Automate patching, compliance checks, and metrics.'
    },
    {
      id: 'proj_ot_visibility',
      name: 'OT / IoT Visibility Pilot',
      capabilityId: 'ot',
      owner: 'OT Security Lead',
      start: '2025-05-01',
      target: '2025-11-30',
      maturityImpact: 1,
      taskIds: ['t25'],
      notes: 'Visibility and anomaly detection in a pilot segment.'
    },
    {
      id: 'proj_risk_register',
      name: 'Risk & TPRM Modernization',
      capabilityId: 'risk',
      owner: 'GRC Lead',
      start: '2025-01-15',
      target: '2025-05-31',
      maturityImpact: 1,
      taskIds: ['t27'],
      notes: 'Centralized risk register and automated third-party intake.'
    }
  ];

  const TOOL_LEVEL_LABELS = [
    'Not in use',
    'Deployed / basic',
    'Use-case driven',
    'Optimized / automated'
  ];

  const STATUS_CYCLE = ['Not Started', 'In Progress', 'Blocked', 'Done'];

  // Roadmap filtering (e.g., set from Program Overview domain cards)
  let roadmapFilterCapabilityIds = null;
  let roadmapFilterLabel = null;
  let roadmapFilterPhase = null;


  // ---------- Persistence ------------------

  function loadState() {
    try {
      const raw = localStorage.getItem('cisoNavigatorDataV1');
      if (!raw) return;
      const data = JSON.parse(raw);
      if (Array.isArray(data.capabilities)) capabilities = data.capabilities;
      if (Array.isArray(data.tools)) tools = data.tools;
      
      if (Array.isArray(data.toolCapabilities)) toolCapabilities = data.toolCapabilities;
if (Array.isArray(data.tasks)) tasks = data.tasks;
      if (Array.isArray(data.skills)) skills = data.skills;
      if (Array.isArray(data.metrics)) metrics = data.metrics;
      if (Array.isArray(data.irPlaybooks)) irPlaybooks = data.irPlaybooks;
      if (Array.isArray(data.projects)) projects = data.projects;
    } catch (e) {
      console.warn('Could not load state from localStorage', e);
    }
  }

  function saveState() {
    try {
      const data = {
        capabilities,
        tools,
        tasks,
        skills,
        metrics,
        irPlaybooks,
        projects
      };
      localStorage.setItem('cisoNavigatorDataV1', JSON.stringify(data));
    } catch (e) {
      console.warn('Could not save state to localStorage', e);
    }
  }

  loadState();

  // ---------- Helpers ------------------

  function cycleStatus(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    const idx = STATUS_CYCLE.indexOf(task.status);
    const nextIdx = idx === -1 ? 0 : (idx + 1) % STATUS_CYCLE.length;
    task.status = STATUS_CYCLE[nextIdx];
    saveState();
  }

  function statusClass(status) {
    if (status === 'Done') return 'ok';
    if (status === 'In Progress') return 'warn';
    if (status === 'Blocked') return 'bad';
    return '';
  }

  function cycleToolLevel(toolId) {
    const tool = tools.find(t => t.id === toolId);
    if (!tool) return;
    const next = (tool.currentLevel + 1) % 4;
    tool.currentLevel = next;
    saveState();
  }

  function toolLevelClass(level, target) {
    if (level >= target) return 'ok';
    if (target - level === 1) return 'warn';
    return 'bad';
  }

  function heatmapCellClass(tool, capId) {
    if (!tool.capabilities.includes(capId)) return 'heatmap-cell-none';
    const level = tool.currentLevel;
    if (level === 0) return 'heatmap-cell-none';
    if (level === 1) return 'heatmap-cell-low';
    if (level === 2) return 'heatmap-cell-med';
    return 'heatmap-cell-high';
  }

  // Project helpers

  function getProjectTasks(project) {
    return tasks.filter(t => project.taskIds?.includes(t.id));
  }

  function getProjectStatus(project) {
    const projTasks = getProjectTasks(project);
    if (!projTasks.length) return 'Not Started';

    const allDone = projTasks.every(t => t.status === 'Done');
    const anyInProgress = projTasks.some(t => t.status === 'In Progress');
    const anyBlocked = projTasks.some(t => t.status === 'Blocked');

    if (allDone) return 'Complete';
    if (anyBlocked) return 'Blocked';
    if (anyInProgress) return 'Active';
    return 'Not Started';
  }

  function getProjectProgress(project) {
    const projTasks = getProjectTasks(project);
    const total = projTasks.length || 0;
    const done = projTasks.filter(t => t.status === 'Done').length;
    const percent = total === 0 ? 0 : Math.round((done / total) * 100);
    return { done, total, percent };
  }

  function projectedMaturity(cap) {
    const impact = projects
      .filter(p => p.capabilityId === cap.id)
      .reduce((sum, p) => sum + (p.maturityImpact || 0), 0);
    const projected = Math.min(cap.targetMaturity, cap.maturity + impact);
    return projected;
  }

  // CRUD helpers

  
  function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    openFormModal({
      title: 'Edit Task',
      subtitle: 'Update ownership, phase, and status without leaving the page.',
      fields: [
        { name: 'title', label: 'Title', type: 'text', required: true, full: true },
        { name: 'capabilityId', label: 'Capability', type: 'select', options: capabilities.map(c => ({value:c.id,label:c.name})), required: true, full: true },
        { name: 'owner', label: 'Owner', type: 'text', required: true },
        { name: 'phase', label: 'Phase', type: 'select', options: ['Foundation','Core','Optimize'], required: true },
        { name: 'impact', label: 'Impact', type: 'select', options: ['High','Medium','Low'], required: true },
        { name: 'status', label: 'Status', type: 'select', options: STATUS_CYCLE, required: true },
        { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, full: true }
      ],
      initial: {
        title: task.title,
        capabilityId: task.capabilityId,
        owner: task.owner,
        phase: task.phase || task.quarter,
        impact: task.impact,
        status: task.status,
        notes: task.notes || ''
      },
      onSave: (d) => {
        task.title = String(d.title).trim();
        task.capabilityId = d.capabilityId;
        task.owner = String(d.owner).trim();
        task.phase = d.phase;
        task.quarter = d.phase;
        task.impact = d.impact;
        task.status = d.status;
        task.notes = d.notes || '';
        saveState();
        renderView(currentView, currentSelectedId);
      }
    });
  }


  function deleteTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    if (!confirm(`Delete task: "${task.title}"?`)) return;
    tasks = tasks.filter(t => t.id !== taskId);
    // Remove from projects
    projects.forEach(p => {
      if (Array.isArray(p.taskIds)) {
        p.taskIds = p.taskIds.filter(id => id !== taskId);
      }
    });
    saveState();
  }

  
  function editTool(toolId) {
    const tool = tools.find(t => t.id === toolId);
    if (!tool) return;

    openFormModal({
      title: 'Edit Tool / App',
      subtitle: 'Update inventory metadata. Capability maturity is tracked per capability below.',
      fields: [
        { name: 'name', label: 'Tool Name', type: 'text', required: true, full: true },
        { name: 'vendor', label: 'Vendor', type: 'text', required: true },
        { name: 'category', label: 'Category', type: 'text', required: true },
        { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, full: true }
      ],
      initial: { name: tool.name, vendor: tool.vendor || '', category: tool.category || '', notes: tool.notes || '' },
      onSave: (d) => {
        tool.name = String(d.name).trim();
        tool.vendor = String(d.vendor).trim();
        tool.category = String(d.category).trim();
        tool.notes = d.notes || '';
        saveState();
        renderView(currentView, currentSelectedId);
      }
    });
  }


  function deleteTool(toolId) {
    const tool = tools.find(t => t.id === toolId);
    if (!tool) return;
    if (!confirm(`Delete tool: "${tool.name}"?`)) return;
    tools = tools.filter(t => t.id !== toolId);
    saveState();
  }

  
  function editProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    openFormModal({
      title: 'Edit Project',
      subtitle: 'Projects bundle tasks into measurable maturity moves.',
      fields: [
        { name: 'name', label: 'Project Name', type: 'text', required: true, full: true },
        { name: 'capabilityId', label: 'Capability', type: 'select', options: capabilities.map(c => ({value:c.id,label:c.name})), required: true, full: true },
        { name: 'owner', label: 'Owner', type: 'text', required: true },
        { name: 'start', label: 'Start Date', type: 'date', required: true },
        { name: 'target', label: 'Target Date', type: 'date', required: true },
        { name: 'priority', label: 'Priority', type: 'select', options: ['High','Medium','Low'], required: true },
        { name: 'maturityImpact', label: 'Maturity Impact (+)', type: 'number', min: 0, max: 5, step: 1, required: true },
        { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, full: true }
      ],
      initial: {
        name: project.name,
        capabilityId: project.capabilityId,
        owner: project.owner,
        start: project.start,
        target: project.target,
        priority: project.priority || 'Medium',
        maturityImpact: project.maturityImpact ?? 1,
        notes: project.notes || ''
      },
      onSave: (d) => {
        project.name = String(d.name).trim();
        project.capabilityId = d.capabilityId;
        project.owner = String(d.owner).trim();
        project.start = d.start;
        project.target = d.target;
        project.priority = d.priority;
        project.maturityImpact = Number(d.maturityImpact ?? 1);
        project.notes = d.notes || '';
        saveState();
        renderView(currentView, currentSelectedId);
      }
    });
  }


  function deleteProject(projectId) {
    const p = projects.find(pr => pr.id === projectId);
    if (!p) return;
    if (!confirm(`Delete project: "${p.name}"?`)) return;
    projects = projects.filter(pr => pr.id !== projectId);
    saveState();
  }

  // ---------- Header / nav ------------------

  function setHeader(viewKey) {
    const breadcrumbsEl = document.getElementById('breadcrumbs');
    const titleEl = document.getElementById('view-title');
    const subtitleEl = document.getElementById('view-subtitle');

    const configs = {
      overview: {
        bc: 'PROGRAM ▸ OVERVIEW',
        title: 'Program Overview',
        sub: 'High-level snapshot of your security program.'
      },
      guided: {
        bc: 'PROGRAM ▸ GUIDED PLAN',
        title: 'Guided Plan for Small Teams',
        sub: 'Start from zero and grow a real security program in phases.'
      },
      capabilities: {
        bc: 'PROGRAM ▸ CAPABILITIES',
        title: 'Capability Explorer',
        sub: 'Your mind map as a navigable capability model.'
      },
      maturity: {
        bc: 'PROGRAM ▸ MATURITY',
        title: 'Maturity Assessment',
        sub: '0—5 scoring across all program domains.'
      },
      projects: {
        bc: 'PROGRAM ▸ PROJECTS',
        title: 'Projects',
        sub: 'Bundle tasks into epics that move maturity.'
      },
      roadmap: {
        bc: 'PROGRAM ▸ ROADMAP',
        title: 'Roadmap',
        sub: 'From gaps to funded, prioritized work.'
      },
      tools: {
        bc: 'OPS ▸ TOOLS',
        title: 'Tools & Platforms',
        sub: 'Inventory, current usage, and maturity opportunities.'
      },
      heatmap: {
        bc: 'OPS ▸ HEATMAP',
        title: 'Tool Heatmap',
        sub: 'Which tools power which capabilities, and how strongly.'
      },
      skills: {
        bc: 'PEOPLE ▸ SKILLS',
        title: 'Skills & Coverage',
        sub: 'Do we have the skills to run the program we designed?'
      },
      ir: {
        bc: 'OPS ▸ INCIDENT RESPONSE',
        title: 'Incident Response Hub',
        sub: 'Playbooks, tests, and readiness at a glance.'
      },
      metrics: {
        bc: 'EXCO ▸ METRICS',
        title: 'Metrics & Reporting',
        sub: 'Executive-ready, operationally useful measurements.'
      }
    };

    const cfg = configs[viewKey] || configs.overview;
    breadcrumbsEl.textContent = cfg.bc;
    titleEl.textContent = cfg.title;
    subtitleEl.textContent = cfg.sub;

    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === viewKey);
    });
  }

  // ---------- Views ------------------

  
  function renderOverview() {
    const container = document.getElementById('view-container');

    const avgMaturity =
      capabilities.reduce((acc, c) => acc + c.maturity, 0) / (capabilities.length || 1);
    const highImpactGaps = capabilities.filter(c => c.maturity <= 2);
    const doneTasks = tasks.filter(t => t.status === 'Done').length;

    const avgTc = toolCapabilities.length
      ? toolCapabilities.reduce((s, tc) => s + (Number(tc.currentMaturity) || 0), 0) / toolCapabilities.length
      : null;

    const activeProjectsCount = projects.filter(
      p => ['Active', 'Blocked'].includes(getProjectStatus(p))
    ).length;
    const domainSummaries = mindmapSections.map(sec => {
      const caps = sec.capabilityIds.map(id => capabilities.find(c => c.id === id)).filter(Boolean);
      const capAvg = caps.length ? (caps.reduce((s,c)=>s+Number(c.maturity||0),0)/caps.length) : 0;
      const capTargetAvg = caps.length ? (caps.reduce((s,c)=>s+Number(c.targetMaturity||0),0)/caps.length) : 0;
      const secTasks = tasks.filter(t => sec.capabilityIds.includes(t.capabilityId));
      const done = secTasks.filter(t => t.status === 'Done').length;
      const inProg = secTasks.filter(t => t.status === 'In Progress').length;
      const blocked = secTasks.filter(t => t.status === 'Blocked').length;
      const pct = secTasks.length ? Math.round((done/secTasks.length)*100) : 0;

      const secProjects = projects.filter(p => sec.capabilityIds.includes(p.capabilityId));
      const toolRows = toolCapabilities.filter(tc => sec.capabilityIds.includes(tc.capabilityId));
      const toolIds = [...new Set(toolRows.map(r=>r.toolId))];
      const tcAvg = toolRows.length ? (toolRows.reduce((s,r)=>s+Number(r.currentMaturity||0),0)/toolRows.length) : 0;

      const biggestGaps = caps
        .map(c => ({id:c.id, name:c.name, gap: Math.max(0, Number(c.targetMaturity||0) - Number(c.maturity||0))}))
        .sort((a,b)=>b.gap-a.gap)
        .slice(0,3)
        .filter(x=>x.gap>0);

      return { sec, caps, capAvg, capTargetAvg, secTasks, done, inProg, blocked, pct, secProjects, toolIds, tcAvg, biggestGaps };
    });



    // NOW MODE: simple “next best actions” for small teams
    const phaseRank = { 'Foundation': 0, 'Core': 1, 'Optimize': 2 };
    const impactRank = { 'High': 0, 'Medium': 1, 'Low': 2 };
    const capacityLimit = 5;
    const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;

    const nextTasks = tasks
      .filter(t => t.status === 'Not Started' || t.status === 'Blocked')
      .sort((a, b) => {
        const ar = (phaseRank[a.phase] ?? 9) - (phaseRank[b.phase] ?? 9);
        if (ar !== 0) return ar;
        const ir = (impactRank[a.impact] ?? 9) - (impactRank[b.impact] ?? 9);
        if (ir !== 0) return ir;
        return String(a.title).localeCompare(String(b.title));
      })
      .slice(0, 3);


    // Weekly Ops: pick a focus capability (largest gap) and show 1 metric + blockers
    const focusCapability = [...capabilities]
      .sort((a,b)=> ((b.targetMaturity||0)-(b.maturity||0)) - ((a.targetMaturity||0)-(a.maturity||0)) )[0] || null;

    const blockers = tasks.filter(t => t.status === 'Blocked').slice(0, 5);
    const focusMetric = metrics[0] || null;

    const overlap = computeOverlapInsights();
    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Program Posture</div>
                <div class="card-subtitle">Capabilities, tasks, projects, and tool capability maturity.</div>
              </div>
              <div class="metric-pill"><span class="tag-dot"></span>Real-time view</div>
            </div>

            <div class="split">
              <div>
                <div class="metric-row">
                  <div class="metric-label">Average capability maturity</div>
                  <div class="metric-value">${avgMaturity.toFixed(1)} / 5</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Capabilities below target</div>
                  <div class="metric-value">${highImpactGaps.length} / ${capabilities.length}</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Guided plan tasks done</div>
                  <div class="metric-value">${doneTasks} / ${tasks.length}</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Active / blocked projects</div>
                  <div class="metric-value">${activeProjectsCount} / ${projects.length}</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Avg tool-capability maturity</div>
                  <div class="metric-value">${avgTc === null ? '—' : avgTc.toFixed(1) + ' / 5'}</div>
                </div>

                <div class="sparkline"><div class="sparkline-fill"></div></div>
              </div>

              <div>
                <div class="section-title">Signals</div>
                <div class="list">
                  <div class="list-item" style="cursor:default">
                    <div>Measure tools by capability maturity, not “installed vs not”.</div>
                    <div class="badge-row"><span class="badge chip">Tool × Capability</span><span class="badge">0–5 maturity</span></div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Use the heatmap to find under-used capabilities before buying new tools.</div>
                    <div class="badge-row"><span class="badge chip">Heatmap</span><span class="badge">Focus uplift</span></div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Turn the largest gaps into 2–5 projects with owners and dates.</div>
                    <div class="badge-row"><span class="badge chip">Projects</span><span class="badge">Executive story</span></div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Now Mode</div>
                <div class="card-subtitle">Next-best actions for a small team (based on phase + impact).</div>
              </div>
              <div class="metric-pill">
                <span class="tag-dot ${inProgressCount >= capacityLimit ? 'bad' : (inProgressCount >= capacityLimit - 1 ? 'warn' : '')}"></span>
                ${inProgressCount} in progress / ${capacityLimit} capacity
              </div>
            </div>

            <div class="section-note">
              Pick a small number of tasks and finish them. Don’t start 20 things.
            </div>

            <div class="list">
              ${nextTasks.length ? nextTasks.map(t => {
                const cap = capabilities.find(c => c.id === t.capabilityId);
                return `
                  <div class="list-item" style="cursor:default">
                    <div><strong>${escapeHtml(t.title)}</strong></div>
                    <div class="section-note">${escapeHtml(cap?.name || t.capabilityId)} · ${escapeHtml(t.phase)} · Impact ${escapeHtml(t.impact)}</div>
                    <div class="badge-row">
                      <span class="badge chip task-status" data-task-id="${t.id}">
                        <span class="tag-dot ${statusClass(t.status)}"></span>${escapeHtml(t.status)}
                      </span>
                      <span class="badge">Owner: ${escapeHtml(t.owner || 'Unassigned')}</span>
                    </div>
                    <div class="action-row">
                      <button type="button" class="action-link task-edit" data-task-id="${t.id}">Edit</button>
                      <button type="button" class="action-link task-start" data-task-id="${t.id}">Start</button>
                    </div>
                  </div>
                `;
              }).join('') : `<div class="section-note">No tasks available. Add tasks in Guided Plan or Roadmap.</div>`}
            </div>

            <div class="action-row" style="margin-top:10px;">
              <button class="primary-btn" id="start-now-mode" type="button">Start all 3</button>
              <button class="mini-btn" id="go-guided" type="button">Go to Guided Plan</button>
            </div>

          </div>
        </div>
      </div>
    
      <div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Weekly Ops</div>
              <div class="card-subtitle">One focus, a few tasks, and a short status update.</div>
            </div>
          </div>

          <div class="detail-panel">
            <div class="detail-title">Focus capability</div>
            <div class="detail-body">
              ${focusCapability ? `<strong>${escapeHtml(focusCapability.name)}</strong> (Gap ${Math.max(0,(focusCapability.targetMaturity||0)-(focusCapability.maturity||0))})` : 'No capability data.'}
            </div>
            <div class="action-row">
              ${focusCapability ? `<button type="button" class="mini-btn" id="weekly-open-cap" data-cap-id="${focusCapability.id}">Open capability</button>` : ''}
              <button type="button" class="mini-btn" id="weekly-copy-update">Copy weekly update</button>
            </div>
          </div>

          <div class="detail-panel" style="margin-top:10px;">
            <div class="detail-title">Blockers</div>
            <div class="detail-body">
              ${blockers.length ? blockers.map(b=>`• ${escapeHtml(b.title)} (${escapeHtml(b.owner||'')})`).join('<br/>') : 'None 🎉'}
            </div>
          </div>

          <div class="detail-panel" style="margin-top:10px;">
            <div class="detail-title">Metric to watch</div>
            <div class="detail-body">
              ${focusMetric ? `<strong>${escapeHtml(focusMetric.name)}</strong>: ${escapeHtml(focusMetric.value)} (${escapeHtml(focusMetric.trend)})` : 'No metrics configured.'}
            </div>
          </div>
        </div>
      </div>

      
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Program Overview by Domain</div>
                <div class="card-subtitle">Use the site’s data to track real progress against guidance.</div>
              </div>
            </div>

            <div class="section-note">
              These domains used to be informational “guidance.” Now they show how your <strong>capabilities, tools, tasks, and projects</strong> are being used to reach the target state.
            </div>

            <div class="list">
              ${domainSummaries.map((d, idx) => {
                const gap = Math.max(0, d.capTargetAvg - d.capAvg);
                const dotCls = gap === 0 ? '' : gap <= 1 ? 'warn' : 'bad';
                const toolCount = d.toolIds.length;
                return `
                  <div class="list-item" style="cursor:default">
                    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
                      <div>
                        <div><strong>${escapeHtml(d.sec.title)}</strong></div>
                        <div class="section-note">${escapeHtml(d.sec.focus)}</div>
                        <div class="badge-row">
                          <span class="badge chip">${escapeHtml(d.sec.nist.join(' / '))}</span>
                          <span class="badge">Capabilities: ${d.caps.length}</span>
                          <span class="badge">Tools mapped: ${toolCount}</span>
                        </div>
                      </div>
                      <div class="metric-pill" title="Avg capability maturity vs target">
                        <span class="tag-dot ${dotCls}"></span>${d.capAvg.toFixed(1)} → ${d.capTargetAvg.toFixed(1)}
                      </div>
                    </div>

                    <div class="chips-row" style="margin-top:6px;">
                      <span class="chip-pill">Work: ${d.done}/${d.secTasks.length} done (${d.pct}%)</span>
                      <span class="chip-pill">In progress: ${d.inProg}</span>
                      <span class="chip-pill">Blocked: ${d.blocked}</span>
                      <span class="chip-pill">Avg tool-cap maturity: ${d.tcAvg.toFixed(1)} / 5</span>
                      <span class="chip-pill">Projects: ${d.secProjects.length}</span>
                    </div>

                    ${d.biggestGaps.length ? `
                      <div class="section-note" style="margin-top:6px;">Biggest gaps</div>
                      <div class="badge-row">
                        ${d.biggestGaps.map(g => `<span class="badge">${escapeHtml(g.name)} (gap ${g.gap})</span>`).join('')}
                      </div>
                    ` : `<div class="section-note" style="margin-top:6px;">No maturity gaps in this domain (at current targets).</div>`}

                    <div class="action-row">
                      <button type="button" class="mini-btn" data-domain-roadmap="${idx}">View domain work</button>
                      <button type="button" class="mini-btn" data-domain-heatmap="${idx}">View heatmap</button>
                      <button type="button" class="mini-btn" data-domain-capability="${idx}">Open a capability</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Guidance Categories as Outcomes</div>
                <div class="card-subtitle">Foundation → Core → Optimize coverage by domain.</div>
              </div>
            </div>

            <div class="detail-panel">
              ${['Foundation','Core','Optimize'].map(phase => {
                const phaseTasks = tasks.filter(t => t.phase === phase);
                const done = phaseTasks.filter(t => t.status === 'Done').length;
                const pct = phaseTasks.length ? Math.round((done/phaseTasks.length)*100) : 0;
                const inProg = phaseTasks.filter(t => t.status === 'In Progress').length;
                const blocked = phaseTasks.filter(t => t.status === 'Blocked').length;
                return `
                  <div style="margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div class="detail-title">${escapeHtml(phase)}</div>
                      <div class="metric-pill"><span class="tag-dot ${blocked? 'bad': inProg? 'warn':''}"></span>${done}/${phaseTasks.length} (${pct}%)</div>
                    </div>
                    <div class="chips-row" style="margin-top:6px;">
                      <span class="chip-pill">In progress: ${inProg}</span>
                      <span class="chip-pill">Blocked: ${blocked}</span>
                      <span class="chip-pill">Not started: ${phaseTasks.filter(t => t.status === 'Not Started').length}</span>
                    </div>
                    <div class="action-row">
                      <button type="button" class="mini-btn" data-phase-roadmap="${escapeHtml(phase)}">View ${escapeHtml(phase)} tasks</button>
                    </div>
                  </div>
                `;
              }).join('')}
              <div class="section-note">
                Use these to drive your weekly and quarterly planning: keep Foundations moving, avoid too many “Optimize” tasks before Core is stable.
              </div>
            </div>
          </div>
        </div>
<div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Tool Overlap & Coverage</div>
              <div class="card-subtitle">Consolidation candidates and missing coverage.</div>
            </div>
          </div>

          <div class="detail-panel">
            <div class="detail-title">Missing coverage</div>
            <div class="detail-body">
              ${overlap.missing.length ? overlap.missing.slice(0,6).map(o=>`• ${escapeHtml(o.cap.name)}`).join('<br/>') : 'None'}
            </div>
          </div>

          <div class="detail-panel" style="margin-top:10px;">
            <div class="detail-title">Weak overlaps</div>
            <div class="detail-body">
              ${overlap.weakOverlaps.length ? overlap.weakOverlaps.slice(0,6).map(o=>{
                const toolNames = o.rows.map(r=>tools.find(t=>t.id===r.toolId)?.name || r.toolId).join(', ');
                return `• ${escapeHtml(o.cap.name)} (avg ${o.avg.toFixed(1)}) → ${escapeHtml(toolNames)}`;

    // Weekly Ops wiring
    container.querySelector('#weekly-open-cap')?.addEventListener('click', (e) => {
      const id = e.currentTarget.getAttribute('data-cap-id');
      renderView('capabilities', id);
    });
    container.querySelector('#weekly-copy-update')?.addEventListener('click', () => {
      const focus = focusCapability ? focusCapability.name : '—';
      const done = tasks.filter(t=>t.status==='Done').length;
      const inprog = tasks.filter(t=>t.status==='In Progress').length;
      const blocked = tasks.filter(t=>t.status==='Blocked').length;
      const msg = [
        `Weekly InfoSec Update`,
        `Focus: ${focus}`,
        `Progress: ${done} tasks done; ${inprog} in progress; ${blocked} blocked`,
        focusMetric ? `Metric: ${focusMetric.name} = ${focusMetric.value} (${focusMetric.trend})` : ``,
        blockers.length ? `Blockers: ${blockers.map(b=>b.title).join(' | ')}` : `Blockers: None`,
        `Next: ${nextTasks.map(t=>t.title).join(' | ') || '—'}`
      ].filter(Boolean).join('\n');
      navigator.clipboard?.writeText(msg);
      toast('Copied weekly update');
    });
              }).join('<br/>') : 'None'}
            </div>
            <div class="section-note" style="margin-top:6px;">If multiple tools overlap but all are low maturity, uplift one before buying more.</div>
          </div>
        </div>
      </div>
`;

    // Now Mode actions
    container.querySelectorAll('.task-start').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = tasks.find(x => x.id === btn.dataset.taskId);
        if (!t) return;
        t.status = 'In Progress';
        saveState();
        renderView('overview');
      });
    });
    container.querySelectorAll('.task-edit').forEach(btn => {
      btn.addEventListener('click', () => editTask(btn.dataset.taskId));
    });
    container.querySelector('#start-now-mode')?.addEventListener('click', () => {
      nextTasks.forEach(t => {
        const task = tasks.find(x => x.id === t.id);
        if (task) task.status = 'In Progress';
      });
      saveState();
      renderView('overview');
    });
    container.querySelector('#go-guided')?.addEventListener('click', () => renderView('guided'));
  }


  function renderGuidedPlan() {
    const container = document.getElementById('view-container');
    const phases = ['Foundation', 'Core', 'Optimize'];

    function phaseSummary(phase) {
      const phaseTasks = tasks.filter(t => t.phase === phase);
      if (!phaseTasks.length) return 'No tasks yet.';
      const done = phaseTasks.filter(t => t.status === 'Done').length;
      return `${done} / ${phaseTasks.length} tasks done`;
    }

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Guided Plan</div>
                <div class="card-subtitle">Opinionated steps to get from zero → functioning security program.</div>
              </div>
            </div>

            <div class="section-note">
              Click the status pill on any task to move it from Not Started → In Progress → Blocked → Done.
            </div>

            <div class="list">
              ${phases
                .map(phase => {
                  const phaseTasks = tasks.filter(t => t.phase === phase);
                  if (!phaseTasks.length) return '';
                  return `
                    <div class="detail-panel" style="margin-top:8px;">
                      <div class="detail-title">${phase}</div>
                      <div class="detail-body">${phase === 'Foundation'
                        ? 'First 3–6 months: get basic governance, logging, and IR in place.'
                        : phase === 'Core'
                        ? '6–18 months: deepen detection, IR, and cloud; start AI guardrails.'
                        : '18+ months: automate, measure, and systematize.'}
                      </div>
                      <div class="chips-row">
                        <div class="chip-pill em">${phaseSummary(phase)}</div>
                      </div>

                      <div class="list" style="margin-top:8px;">
                        ${phaseTasks
                          .map(t => {
                            const capName = capabilities.find(c => c.id === t.capabilityId)?.name || '';
                            const cls = statusClass(t.status);
                            return `
                              <div class="list-item" style="cursor:default">
                                <div><strong>${t.title}</strong></div>
                                <div class="section-note">${capName} · Owner: ${t.owner}</div>
                                <div class="badge-row">
                                  <span class="badge chip task-status" data-task-id="${t.id}">
                                    <span class="tag-dot ${cls}"></span>${t.status}
                                  </span>
                                  <span class="badge">Phase: ${phase}</span>
                                  <span class="badge">Impact: ${t.impact}</span>
                                </div>
                                <div class="action-row">
                                  <button type="button" class="action-link task-edit" data-task-id="${t.id}">Edit</button>
                                  <button type="button" class="action-link danger task-delete" data-task-id="${t.id}">Delete</button>
                                </div>
                              </div>
                            `;
                          })
                          .join('')}
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>

            <div class="detail-panel" style="margin-top:12px;">
              <div class="detail-title">Add Task</div>
              <div class="detail-body">
                <form id="add-task-form">
                  <div class="form-row">
                    <input class="form-input" name="title" placeholder="Task title (e.g., Integrate Falcon with SIEM)" />
                  </div>
                  <div class="form-row">
                    <select class="select-input" name="capabilityId">
                      ${capabilities
                        .map(cap => `<option value="${cap.id}">${cap.name}</option>`)
                        .join('')}
                    </select>
                    <select class="select-input" name="phase">
                      <option value="Foundation">Foundation</option>
                      <option value="Core">Core</option>
                      <option value="Optimize">Optimize</option>
                    </select>
                    <select class="select-input" name="impact">
                      <option value="High">High</option>
                      <option value="Medium">Medium</option>
                      <option value="Low">Low</option>
                    </select>
                  </div>
                  <div class="form-row">
                    <input class="form-input" name="owner" placeholder="Owner (optional)" />
                  </div>
                  <button type="submit" class="primary-btn">Add Task</button>
                </form>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">How to Use This as a Small Team</div>
                <div class="card-subtitle">You do not need a 50-page strategy doc.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Working rhythm</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Pick 3–5 <strong>Foundation</strong> tasks and make those your non-negotiable focus.</li>
                  <li>Review status weekly as a team and move tasks forward a single notch.</li>
                  <li>When most Foundation items are Done, pull from <strong>Core</strong>.</li>
                  <li>Use <strong>Maturity</strong>, <strong>Projects</strong>, and <strong>Metrics</strong> views to show progress to leadership.</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">Capacity guardrail</div>
                <div class="detail-body">
                  Small team rule of thumb:
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>1–2 people → <strong>max 3 active tasks</strong> In Progress.</li>
                    <li>3–5 people → <strong>max 6 active tasks</strong> In Progress.</li>
                  </ul>
                  If more than that are In Progress, you&apos;re likely spreading too thin.
                </div>
              </div>
            </div>
          </div>
        </div>

        
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Guidance moved to Overview</div>
                <div class="card-subtitle">See domain-level progress and usage on Program Overview.</div>
              </div>
            </div>
            <div class="detail-panel">
              <div class="detail-title">Why</div>
              <div class="detail-body">
                Domain Guidance and Guidance Categories are now used in <strong>Program Overview</strong> to show how the rest of the site (tools, tasks, projects, heatmap) is driving maturity outcomes.
              </div>
              <div class="action-row">
                <button type="button" class="mini-btn" data-jump="overview">Go to Program Overview</button>
              </div>
            </div>
          </div>
        </div>

    `;

    wireTaskStatusClickHandlers(container);
    wireTaskCrudHandlers(container);

    container.querySelectorAll('[data-jump="capabilities"]').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-capability-id');

    container.querySelectorAll('[data-jump="overview"]').forEach(el => {
      el.addEventListener('click', () => {
        renderView('overview');
      });
    });
        renderView('capabilities', id);
      });
    });

    const addTaskForm = container.querySelector('#add-task-form');
    if (addTaskForm) {
      addTaskForm.addEventListener('submit', e => {
        e.preventDefault();
        const fd = new FormData(addTaskForm);
        const title = (fd.get('title') || '').trim();
        if (!title) return;
        const capabilityId = fd.get('capabilityId') || capabilities[0]?.id || 'governance';
        const phase = fd.get('phase') || 'Foundation';
        const impact = fd.get('impact') || 'Medium';
        const owner = (fd.get('owner') || '').trim() || 'Unassigned';

        const newTask = {
          id: 't_custom_' + Date.now(),
          title,
          capabilityId,
          status: 'Not Started',
          owner,
          quarter: phase,
          impact,
          phase
        };
        tasks.push(newTask);
        saveState();
        renderView('guided');
      });
    }
  }

  function renderCapabilities(selectedId) {
    const container = document.getElementById('view-container');
    const selected =
      capabilities.find(c => c.id === selectedId) || capabilities[0];

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Capability Catalog</div>
                <div class="card-subtitle">Your mind map, normalized into a structured model.</div>
              </div>
              <div class="metric-pill">
                <span class="tag-dot"></span>
                ${capabilities.length} capabilities
              </div>
            </div>

            <div class="section-note">
              Click a capability to see details, ownership, maturity, and linked projects.
            </div>

            <div class="list">
              ${capabilities
                .map(
                  c => `
                    <div class="list-item capability-item" data-id="${c.id}">
                      <div><strong>${c.name}</strong></div>
                      <div class="section-note">${c.domain} · ${c.nist.join(' / ')}</div>
                      <div class="badge-row">
                        <span class="badge chip">Maturity ${c.maturity} / 5</span>
                        <span class="badge">Projects: ${
                          projects.filter(p => p.capabilityId === c.id).length
                        }</span>
                        ${c.tags
                          .map(tag => `<span class="badge">${tag}</span>`)
                          .join('')}
                      </div>
                    </div>
                  `
                )
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Capability Detail</div>
                <div class="card-subtitle">Drill into a single slice of the program.</div>
              </div>
            </div>

            <div class="detail-panel" id="cap-detail-panel"></div>
          </div>
        </div>
      </div>
    `;

    function renderDetail(cap) {
      const panel = document.getElementById('cap-detail-panel');
      const maturityClass =
        cap.maturity >= cap.targetMaturity
          ? 'ok'
          : cap.maturity >= cap.targetMaturity - 1
          ? 'warn'
          : 'bad';

      const relatedTools = tools.filter(t => t.capabilities.includes(cap.id));
      const relatedTasks = tasks.filter(t => t.capabilityId === cap.id);
      const relatedProjects = projects.filter(p => p.capabilityId === cap.id);
      const projMaturity = projectedMaturity(cap);

      panel.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;"><div><div class="detail-title">${cap.name}</div><div class="detail-domain">${cap.domain}</div></div><button type="button" class="mini-btn cap-edit" data-cap-id="${cap.id}">Edit Capability</button></div>
        <div class="detail-domain">${cap.domain} · ${cap.nist.join(' / ')}</div>
        <div class="detail-body">${cap.description}</div>

        <div class="chips-row">
          <div class="chip-pill em">
            <span class="tag-dot ${
              maturityClass === 'bad'
                ? 'bad'
                : maturityClass === 'warn'
                ? 'warn'
                : ''
            }"></span>
            Maturity ${cap.maturity} / ${cap.targetMaturity}
          </div>
          <div class="chip-pill">Owner: ${cap.owner}</div>
          <div class="chip-pill">Horizon: ${cap.timeframe}</div>
          <div class="chip-pill">Projects: ${relatedProjects.length}</div>
          <div class="chip-pill">Projected maturity: ${projMaturity} / ${cap.targetMaturity}</div>
        </div>

        <div class="grid-2" style="margin-top:8px;">
          <div class="pill-stat">
            <span class="pill-stat-label">NIST</span>
            <span class="pill-stat-value">${cap.nist.join(' / ')}</span>
          </div>
          <div class="pill-stat">
            <span class="pill-stat-label">Tags</span>
            <span class="pill-stat-value">${cap.tags.join(', ')}</span>
          </div>
        </div>

        ${
          mindmapSections.filter(sec => sec.capabilityIds.includes(cap.id)).length
            ? `
              <div style="margin-top:10px;">
                <div class="section-title">Guidance</div>
                <div class="list">
                  ${mindmapSections
                    .filter(sec => sec.capabilityIds.includes(cap.id))
                    .map(
                      sec => `
                        <div class="list-item" style="cursor:default">
                          <div><strong>${sec.title}</strong></div>
                          <div class="section-note">${sec.focus}</div>
                          <ul style="margin:6px 0 0 18px; padding:0; font-size:0.84rem; color:var(--muted); line-height:1.4;">
                            ${sec.items
                              .flatMap(item => item.bullets)
                              .map(b => `<li>${b}</li>`)
                              .join('')}
                          </ul>
                        </div>
                      `
                    )
                    .join('')}
                </div>
              </div>
            `
            : ''
        }

        <div style="margin-top:10px;">
          <div class="section-title">Tools that support this capability</div>
          <div class="list">
            ${
              !relatedTools.length
                ? '<div class="section-note">No tools mapped yet.</div>'
                : relatedTools
                    .map(t => `
                        <div class="list-item" style="cursor:default">
                          <div><strong>${t.name}</strong> — ${t.category}</div>
                          <div class="badge-row">
                            <span class="badge">Vendor: ${t.vendor}</span>
                            <span class="badge chip">
                              Level ${t.currentLevel || 0} / ${t.targetLevel || 3} · ${TOOL_LEVEL_LABELS[t.currentLevel || 0]}
                            </span>
                          </div>
                        </div>
                    `)
                    .join('')
            }
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="section-title">Related Projects</div>
          <div class="list">
            ${
              !relatedProjects.length
                ? '<div class="section-note">No projects linked yet.</div>'
                : relatedProjects
                    .map(p => {
                      const status = getProjectStatus(p);
                      const prog = getProjectProgress(p);
                      const statusClassName =
                        status === 'Complete'
                          ? 'ok'
                          : status === 'Blocked'
                          ? 'bad'
                          : status === 'Active'
                          ? 'warn'
                          : '';
                      return `
                        <div class="list-item" style="cursor:default">
                          <div><strong>${p.name}</strong></div>
                          <div class="section-note">Owner: ${p.owner} · ${p.start} → ${p.target}</div>
                          <div class="badge-row">
                            <span class="badge chip">
                              <span class="tag-dot ${statusClassName}"></span>${status}
                            </span>
                            <span class="badge">${prog.done} / ${prog.total || 0} tasks · ${prog.percent}%</span>
                            <span class="badge">Maturity impact: +${p.maturityImpact}</span>
                          </div>
                        </div>
                      `;
                    })
                    .join('')
            }
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="section-title">Related Roadmap Items</div>
          <div class="list">
            ${
              !relatedTasks.length
                ? '<div class="section-note">No items linked yet.</div>'
                : relatedTasks
                    .map(
                      t => `
                    <div class="list-item" style="cursor:default">
                      <div>${t.title}</div>
                      <div class="badge-row">
                        <span class="badge chip task-status" data-task-id="${t.id}">
                          <span class="tag-dot ${statusClass(t.status)}"></span>${t.status}
                        </span>
                        <span class="badge">Owner: ${t.owner}</span>
                        <span class="badge">Impact: ${t.impact}</span>
                        <span class="badge">Phase: ${t.phase}</span>
                      </div>
                      <div class="action-row">
                        <button type="button" class="action-link task-edit" data-task-id="${t.id}">Edit</button>
                        <button type="button" class="action-link danger task-delete" data-task-id="${t.id}">Delete</button>
                      </div>
                    </div>
                    `
                    )
                    .join('')
            }
          </div>
        </div>
      `;
      wireTaskStatusClickHandlers(panel);
      wireTaskCrudHandlers(panel);
    }

    container.querySelectorAll('.capability-item').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-id');
        const cap = capabilities.find(c => c.id === id);
        if (cap) renderDetail(cap);
      });
    });

    if (selected) renderDetail(selected);
  }

  function renderMaturity() {
    const container = document.getElementById('view-container');
    const sorted = [...capabilities].sort((a, b) => a.maturity - b.maturity);

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Maturity by Capability</div>
                <div class="card-subtitle">Lower-scoring areas bubble to the top.</div>
              </div>
            </div>

            <div class="list">
              ${sorted
                .map(c => {
                  const gap = c.targetMaturity - c.maturity;
                  const className =
                    gap <= 0 ? 'ok' : gap === 1 ? 'warn' : 'bad';
                  const tagLabel =
                    gap <= 0
                      ? 'At / above target'
                      : gap === 1
                      ? 'Near target'
                      : 'Gap';
                  const capsProjects = projects.filter(p => p.capabilityId === c.id);
                  const projMaturity = projectedMaturity(c);

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${c.name}</strong></div>
                      <div class="section-note">${c.domain} · ${c.nist.join(' / ')}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          Maturity ${c.maturity} / ${c.targetMaturity}
                        </span>
                        <span class="badge">
                          Gap: ${gap <= 0 ? 0 : gap}
                        </span>
                        <span class="badge">
                          <span class="tag-dot ${className}"></span>${tagLabel}
                        </span>
                        <span class="badge">Projects: ${capsProjects.length}</span>
                        <span class="badge">Projected maturity: ${projMaturity} / ${c.targetMaturity}</span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Assessment Notes</div>
                <div class="card-subtitle">How to use this view.</div>
              </div>
            </div>
            <div class="detail-panel">
              <div class="detail-title">0–5 Scale</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li><strong>0</strong> – Not considered</li>
                  <li><strong>1</strong> – Ad-hoc / heroic</li>
                  <li><strong>2</strong> – Repeatable, but informal</li>
                  <li><strong>3</strong> – Defined & documented</li>
                  <li><strong>4</strong> – Measured & controlled</li>
                  <li><strong>5</strong> – Optimized & continuously improved</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">Next Actions</div>
                <div class="list">
                  <div class="list-item" style="cursor:default">
                    <div>Confirm owners for each capability and have them ratify the scores.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Translate the largest gaps into <strong>Projects</strong> with timelines and funding.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Review and refresh scores on a quarterly or semi-annual cadence.</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Guidance Categories</div>
                <div class="card-subtitle">Categories and sub-categories aligned to projects.</div>
              </div>
            </div>

            <div class="list">
              ${mindmapSections
                .map(sec => {
                  const secCaps = sec.capabilityIds
                    .map(id => capabilities.find(c => c.id === id))
                    .filter(Boolean);
                  const secProjects = projects.filter(p => sec.capabilityIds.includes(p.capabilityId));
                  const secTasks = tasks.filter(t => sec.capabilityIds.includes(t.capabilityId));

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${sec.title}</strong></div>
                      <div class="section-note">${sec.focus}</div>
                      <div class="badge-row">
                        <span class="badge chip">${sec.nist.join(' / ')}</span>
                        <span class="badge">Projects: ${secProjects.length}</span>
                        <span class="badge">Tasks: ${secTasks.length}</span>
                      </div>
                      <div class="chips-row" style="margin-top:4px;">
                        ${
                          secCaps.length
                            ? secCaps
                                .map(c => {
                                  const cls =
                                    c.maturity >= c.targetMaturity
                                      ? 'ok'
                                      : c.targetMaturity - c.maturity === 1
                                      ? 'warn'
                                      : 'bad';
                                  return `
                                    <span class="chip-pill em" data-jump="capabilities" data-capability-id="${c.id}">
                                      <span class="tag-dot ${cls}"></span>${c.name}
                                    </span>
                                  `;
                                })
                                .join('')
                            : '<span class="chip-pill">Map a capability</span>'
                        }
                      </div>
                      <ul style="margin:6px 0 0 18px; padding:0; font-size:0.84rem; color:var(--muted); line-height:1.4;">
                        ${sec.items
                          .map(item => `<li><strong>${item.heading}:</strong> ${item.bullets[0] || ''}</li>`)
                          .join('')}
                      </ul>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderRoadmap() {
    const container = document.getElementById('view-container');

    let filteredTasks = Array.isArray(roadmapFilterCapabilityIds) && roadmapFilterCapabilityIds.length
      ? tasks.filter(t => roadmapFilterCapabilityIds.includes(t.capabilityId))
      : tasks;

    if (roadmapFilterPhase) {
      filteredTasks = filteredTasks.filter(t => t.phase === roadmapFilterPhase);
    }



    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Roadmap Board</div>
                <div class="card-subtitle">Tasks grouped by status and impact.</div>
                ${roadmapFilterLabel ? `<div class="pill-row" style="margin-top:8px;">
                  <span class="pill highlight">Filter: ${escapeHtml(roadmapFilterLabel)}</span>
                  <button class="mini-btn" id="roadmap-clear-filter" type="button">Clear</button>
                </div>` : ``}

              </div>
            </div>

            <div class="split">
              <div>
                <div class="section-title">High Impact</div>
                <div class="list">
                  ${filteredTasks
                    .filter(t => t.impact === 'High')
                    .map(t => {
                      const capName = capabilities.find(c => c.id === t.capabilityId)?.name || '';
                      const cls = statusClass(t.status);
                      return `
                        <div class="list-item" style="cursor:default">
                          <div><strong>${t.title}</strong></div>
                          <div class="section-note">
                            ${capName} · Phase: ${t.phase}
                          </div>
                          <div class="badge-row">
                            <span class="badge chip task-status" data-task-id="${t.id}">
                              <span class="tag-dot ${cls}"></span>${t.status}
                            </span>
                            <span class="badge">Owner: ${t.owner}</span>
                          </div>
                          <div class="action-row">
                            <button type="button" class="action-link task-edit" data-task-id="${t.id}">Edit</button>
                            <button type="button" class="action-link danger task-delete" data-task-id="${t.id}">Delete</button>
                          </div>
                        </div>
                      `;
                    })
                    .join('')}
                </div>
              </div>
              <div>
                <div class="section-title">Medium Impact</div>
                <div class="list">
                  ${filteredTasks
                    .filter(t => t.impact === 'Medium')
                    .map(t => {
                      const capName = capabilities.find(c => c.id === t.capabilityId)?.name || '';
                      const cls = statusClass(t.status);
                      return `
                        <div class="list-item" style="cursor:default">
                          <div><strong>${t.title}</strong></div>
                          <div class="section-note">
                            ${capName} · Phase: ${t.phase}
                          </div>
                          <div class="badge-row">
                            <span class="badge chip task-status" data-task-id="${t.id}">
                              <span class="tag-dot ${cls}"></span>${t.status}
                            </span>
                            <span class="badge">Owner: ${t.owner}</span>
                          </div>
                          <div class="action-row">
                            <button type="button" class="action-link task-edit" data-task-id="${t.id}">Edit</button>
                            <button type="button" class="action-link danger task-delete" data-task-id="${t.id}">Delete</button>
                          </div>
                        </div>
                      `;
                    })
                    .join('')}
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Roadmapping Principles</div>
                <div class="card-subtitle">How this app wants you to think.</div>
              </div>
            </div>
            <div class="detail-panel">
              <div class="detail-title">From capability gap → funded work</div>
              <div class="detail-body">
                <ol style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Rank gaps by impact on risk, operations, and compliance.</li>
                  <li>Bundle related gaps into investable epics (see <strong>Projects</strong> view).</li>
                  <li>Attach timelines, owners, and success metrics.</li>
                  <li>Socialize with business leaders as a portfolio, not one-off tools.</li>
                </ol>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">Signals to Watch</div>
                <div class="list">
                  <div class="list-item" style="cursor:default">
                    <div>Many "High" impact items stuck in "Not Started" or "Blocked".</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Roadmap misaligned with the biggest maturity gaps.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Key items without a named human owner.</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    `;

    wireTaskStatusClickHandlers(container);
    wireTaskCrudHandlers(container);
  }

  
  function renderTools() {
    const container = document.getElementById('view-container');

    const avgTc = toolCapabilities.length
      ? toolCapabilities.reduce((s, tc) => s + (Number(tc.currentMaturity) || 0), 0) / toolCapabilities.length
      : 0;

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Tools & Platforms</div>
                <div class="card-subtitle">Track what each tool can do (capabilities) and how mature each capability is (0–5).</div>
              </div>
              <div class="metric-pill"><span class="tag-dot"></span>${tools.length} tools</div>
            </div>

            <div class="section-note">
              A tool doesn’t have one maturity score. Each tool has multiple capabilities, and each capability can mature independently.
            </div>

            <div class="list">
              ${tools.map(tool => {
                const rows = toolCapabilities.filter(tc => tc.toolId === tool.id);
                const rowsAvg = rows.length
                  ? (rows.reduce((s, r) => s + (Number(r.currentMaturity) || 0), 0) / rows.length).toFixed(1)
                  : '0.0';

                const lastReviewed = rows.map(r => r.lastReviewed).filter(Boolean).sort().slice(-1)[0] || '—';

                return `
                  <div class="detail-panel" style="margin-top:10px; cursor:default;">
                    <div class="detail-title">${tool.name}</div>
                    <div class="detail-domain">${tool.vendor || 'Vendor'} · ${tool.category || 'Category'}</div>

                    <div class="chips-row">
                      <span class="chip-pill em">Avg capability maturity: ${rowsAvg} / 5</span>
                      <span class="chip-pill">Capabilities: ${rows.length}</span>
                      <span class="chip-pill">Last reviewed: ${lastReviewed}</span>
                    </div>

                    ${tool.notes ? `<div class="detail-body" style="margin-top:6px;">${escapeHtml(tool.notes)}</div>` : ''}

                    <div class="action-row">
                      <button type="button" class="action-link tool-edit" data-tool-id="${tool.id}">Edit</button>
                      <button type="button" class="action-link danger tool-delete" data-tool-id="${tool.id}">Delete</button>
                    </div>

                    <div style="margin-top:10px;">
                      <div class="section-title">Capabilities in this tool</div>

                      <div class="list">
                        ${rows.length ? rows.map(r => {
                          const cap = capabilities.find(c => c.id === r.capabilityId);
                          const capName = cap ? cap.name : r.capabilityId;
                          return `
                            <div class="list-item" style="cursor:default">
                              <div><strong>${capName}</strong></div>
                              <div class="section-note">${cap ? cap.domain : ''}</div>

                              <div class="badge-row">
                                <span class="badge chip cap-maturity-pill" data-tc-id="${r.id}" title="Click to cycle 0→5">
                                  <span class="tag-dot ${Number(r.currentMaturity) >= Number(r.targetMaturity || 3) ? '' : (Number(r.targetMaturity || 3) - Number(r.currentMaturity || 0) === 1 ? 'warn' : 'bad')}"></span>
                                  Maturity ${Number(r.currentMaturity || 0)} / 5 · Target ${Number(r.targetMaturity || 3)}
                                </span>
                                <span class="badge">Reviewed: ${r.lastReviewed || '—'}</span>
                              </div>

                              <div class="section-note" style="margin-top:6px;">Notes</div>
                              <textarea class="textarea-input tc-notes" data-tc-id="${r.id}" rows="2" placeholder="Evidence / what’s missing / next steps...">${escapeHtml(r.notes || '')}</textarea>

                              <div class="action-row">
                                <button type="button" class="action-link tc-set-target" data-tc-id="${r.id}">Set target</button>
                                <button type="button" class="action-link danger tc-remove" data-tc-id="${r.id}">Remove</button>
                              </div>
                            </div>
                          `;
                        }).join('') : `<div class="section-note">No capabilities mapped yet. Add one below.</div>`}
                      </div>

                      <div class="detail-panel" style="margin-top:10px;">
                        <div class="detail-title">Add capability to this tool</div>
                        <div class="form-row">
                          <select class="select-input tc-add-cap" data-tool-id="${tool.id}">
                            ${capabilities.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                          </select>
                          <button class="mini-btn tc-add-btn" data-tool-id="${tool.id}">Add</button>
                        </div>
                        <div class="section-note" style="margin-top:6px;">
                          This creates a Tool × Capability row you can mature over time.
                        </div>
                      </div>

                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="detail-panel" style="margin-top:12px;">
              <div class="detail-title">Add Tool</div>
              <div class="detail-body">
                <button class="primary-btn" id="add-tool-btn" type="button">Add Tool</button>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Summary</div>
                <div class="card-subtitle">Program-level tool capability maturity.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">At a glance</div>
              <div class="grid-2">
                <div class="pill-stat">
                  <span class="pill-stat-label">Mapped tool-capabilities</span>
                  <span class="pill-stat-value">${toolCapabilities.length}</span>
                </div>
                <div class="pill-stat">
                  <span class="pill-stat-label">Avg maturity</span>
                  <span class="pill-stat-value ${avgTc >= 3 ? 'ok' : avgTc >= 2 ? 'warn' : 'bad'}">${avgTc.toFixed(1)} / 5</span>
                </div>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">How to use this</div>
                <div class="detail-body">
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>Map 3–5 capabilities for each major platform first.</li>
                    <li>Set maturity based on real usage (process + people + tuning), not license count.</li>
                    <li>Pick 1–2 uplift targets per quarter and push them +1 maturity.</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    `;

    // tool edit/delete
    container.querySelectorAll('.tool-edit').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); editTool(btn.dataset.toolId); });
    });
    container.querySelectorAll('.tool-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tool = tools.find(t => t.id === btn.dataset.toolId);
        if (!tool) return;
        openModal({
          title: 'Delete Tool',
          subtitle: 'This also removes all Tool × Capability mappings for it.',
          bodyHtml: `<div class="detail-panel"><div class="detail-title">${escapeHtml(tool.name)}</div><div class="detail-body">Are you sure?</div></div>`,
          actions: [
            { label: 'Cancel', className: 'btn', onClick: closeModal },
            { label: 'Delete', className: 'btn danger', onClick: () => {
                tools = tools.filter(t => t.id !== tool.id);
                toolCapabilities = toolCapabilities.filter(tc => tc.toolId !== tool.id);
                saveState();
                closeModal();
                renderView('tools');
              }}
          ]
        });
      });
    });

    // add tool button (modal)
    const addBtn = container.querySelector('#add-tool-btn');
    addBtn?.addEventListener('click', () => {
      openFormModal({
        title: 'Add Tool / App',
        subtitle: 'Add a platform you already own. Map capabilities next.',
        fields: [
          { name: 'name', label: 'Tool Name', type: 'text', required: true, full: true },
          { name: 'vendor', label: 'Vendor', type: 'text', required: true },
          { name: 'category', label: 'Category', type: 'text', required: true },
          { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, full: true }
        ],
        initial: { name:'', vendor:'', category:'', notes:'' },
        saveLabel: 'Add',
        onSave: (d) => {
          tools.push({
            id: 'tool_custom_' + Date.now(),
            name: String(d.name).trim(),
            vendor: String(d.vendor).trim(),
            category: String(d.category).trim(),
            notes: d.notes || ''
          });
          saveState();
          renderView('tools');
        }
      });
    });

    // Add capability to tool
    container.querySelectorAll('.tc-add-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const toolId = btn.dataset.toolId;
        const sel = container.querySelector(`.tc-add-cap[data-tool-id="${toolId}"]`);
        const capId = sel?.value;
        if (!capId) return;
        ensureToolCapability(toolId, capId);
        renderView('tools');
      });
    });

    // Cycle maturity
    container.querySelectorAll('.cap-maturity-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        cycleToolCapMaturity(pill.dataset.tcId);
        renderView('tools');
      });
    });

    // Notes update
    container.querySelectorAll('.tc-notes').forEach(area => {
      area.addEventListener('change', () => {
        const tc = toolCapabilities.find(x => x.id === area.dataset.tcId);
        if (!tc) return;
        tc.notes = area.value;
        tc.lastReviewed = new Date().toISOString().slice(0, 10);
        saveState();
      });
    });

    // Set target
    container.querySelectorAll('.tc-set-target').forEach(btn => {
      btn.addEventListener('click', () => {
        const tc = toolCapabilities.find(x => x.id === btn.dataset.tcId);
        if (!tc) return;
        openFormModal({
          title: 'Set Target Maturity',
          subtitle: 'Target maturity for this tool capability (0–5).',
          fields: [
            { name: 'targetMaturity', label: 'Target (0–5)', type: 'number', min: 0, max: 5, step: 1, required: true, full: true }
          ],
          initial: { targetMaturity: Number(tc.targetMaturity ?? 3) },
          onSave: (d) => {
            const n = Number(d.targetMaturity);
            if (Number.isNaN(n) || n < 0 || n > 5) return;
            tc.targetMaturity = n;
            tc.lastReviewed = new Date().toISOString().slice(0, 10);
            saveState();
            renderView('tools');
          }
        });
      });
    });

    // Remove mapping
    container.querySelectorAll('.tc-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        const tc = toolCapabilities.find(x => x.id === btn.dataset.tcId);
        if (!tc) return;
        const capName = capabilities.find(c => c.id === tc.capabilityId)?.name || tc.capabilityId;
        const toolName = tools.find(t => t.id === tc.toolId)?.name || tc.toolId;
        openModal({
          title: 'Remove Capability Mapping',
          subtitle: `${toolName} → ${capName}`,
          bodyHtml: `<div class="detail-panel"><div class="detail-body">Remove this capability from this tool?</div></div>`,
          actions: [
            { label: 'Cancel', className: 'btn', onClick: closeModal },
            { label: 'Remove', className: 'btn danger', onClick: () => {
                removeToolCapabilityRow(btn.dataset.tcId);
                closeModal();
                renderView('tools');
              } }
          ]
        });
      });
    });
  }


  
  function renderHeatmap() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Tool Capability Heatmap</div>
                <div class="card-subtitle">Cell = maturity (0–5) for Tool × Capability. Click a cell to jump to that tool.</div>
              </div>
            </div>

            <div class="section-note">
              Missing cells mean the capability hasn’t been mapped to that tool yet. Map it in <strong>Tools & Platforms</strong>.
            </div>

            <div class="heatmap-wrapper">
              <table class="heatmap">
                <thead>
                  <tr>
                    <th>Capability</th>
                    ${tools.map(t => `<th class="hm-tool-header" data-tool-id="${t.id}" title="${escapeHtml(t.vendor || '')} • ${escapeHtml(t.category || '')}
Click to open tool">${escapeHtml(t.name)}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${capabilities.map(cap => `
                    <tr>
                      <td class="hm-cap-row" data-cap-id="${cap.id}" title="Click to open capability">${escapeHtml(cap.name)}</td>
                      ${tools.map(tool => {
                        const row = tcKey(tool.id, cap.id);
                        const lvl = row ? Number(row.currentMaturity || 0) : 0;
                        const cls = row ? hmClass(lvl) : 'hm0';
                        const label = row ? `L${lvl}` : '';
                        const title = `${tool.name} × ${cap.name}` + (row ? `
Maturity ${lvl}/5 (Target ${row.targetMaturity ?? 3})` : `
Not mapped yet`);
                        return `<td class="${cls} hm-cell" data-tool-id="${tool.id}" data-cap-id="${cap.id}" title="${escapeHtml(title)}">${label}</td>`;

    // Drilldowns: headers + cells
    container.querySelectorAll('.hm-tool-header').forEach(th => {
      th.addEventListener('click', () => {
        renderView('tools', th.getAttribute('data-tool-id'));
      });
    });

    container.querySelectorAll('.hm-cap-row').forEach(td => {
      td.addEventListener('click', () => {
        renderView('capabilities', td.getAttribute('data-cap-id'));
      });
    });

    container.querySelectorAll('.hm-cell').forEach(td => {
      td.addEventListener('click', () => {
        const toolId = td.getAttribute('data-tool-id');
        const capId = td.getAttribute('data-cap-id');
        if (!toolId || !capId) return;

        // If not mapped yet, create mapping and offer uplift task.
        const row = tcKey(toolId, capId);
        if (!row) {
          ensureToolCapability(toolId, capId);
          saveState();
        }

        openToolCapabilityModal(toolId, capId);
      });
    });
                      }).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div class="section-note" style="margin-top:10px;">
              Tip: use this to find under-used capabilities before buying anything new.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Legend</div>
                <div class="card-subtitle">0–5 maturity scale.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Meaning</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li><span class="badge hm0" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 0 – unused/disabled</li>
                  <li><span class="badge hm1" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 1 – basic/ad-hoc</li>
                  <li><span class="badge hm2" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 2 – repeatable but informal</li>
                  <li><span class="badge hm3" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 3 – defined & documented</li>
                  <li><span class="badge hm4" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 4 – measured & managed</li>
                  <li><span class="badge hm5" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 5 – optimized</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">What to do next</div>
                <div class="detail-body">
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>Pick a critical capability with mostly low cells.</li>
                    <li>Choose one platform to uplift by +1 maturity this quarter.</li>
                    <li>Create 1–3 tasks and tie them to a project.</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    `;

    container.querySelectorAll('.hm-cell').forEach(td => {
      td.addEventListener('click', () => {
        const toolId = td.dataset.toolId;
        renderView('tools', toolId);
        // scroll to tool panel
        setTimeout(() => {
          const el = document.querySelector(`[data-tool-id="${toolId}"]`);
          el?.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
        }, 50);
      });
    });
  }


  function renderSkills() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Team Skills Matrix</div>
                <div class="card-subtitle">Coverage across critical domains.</div>
              </div>
            </div>

            <div class="list">
              ${skills
                .map(s => {
                  const gap = s.target - s.level;
                  const className =
                    gap <= 0 ? 'ok' : gap === 1 ? 'warn' : 'bad';
                  const label =
                    gap <= 0
                      ? 'Target met'
                      : gap === 1
                      ? 'Near target'
                      : 'Needs uplift';

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${s.person}</strong> — ${s.skill}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          Level ${s.level} / ${s.target}
                        </span>
                        <span class="badge">
                          <span class="tag-dot ${className}"></span>${label}
                        </span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Coverage Highlights</div>
                <div class="card-subtitle">Where to invest training and hiring.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Gaps worth watching</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>AI / GenAI strategy and guardrails.</li>
                  <li>OT / ICS security depth for critical environments.</li>
                  <li>Cloud security engineering, especially for multi-cloud.</li>
                  <li>Crisis communications and cross-business incident leadership.</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">Actions</div>
                <div class="list">
                  <div class="list-item" style="cursor:default">
                    <div>Turn the biggest skill gaps into targeted learning paths or hiring plans.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Pair junior staff with senior leads via structured shadowing in IR, threat detection, and cloud.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Run a quarterly skills review alongside your maturity assessment.</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderIR() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">IR Playbooks</div>
                <div class="card-subtitle">Key scenarios and their test cadence.</div>
              </div>
            </div>

            <div class="list">
              ${irPlaybooks
                .map(pb => {
                  const statusClassName =
                    pb.status === 'Healthy'
                      ? 'ok'
                      : pb.status === 'Needs Retest'
                      ? 'warn'
                      : 'bad';

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${pb.name}</strong></div>
                      <div class="section-note">Owner: ${pb.owner}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          <span class="tag-dot ${statusClassName}"></span>${pb.status}
                        </span>
                        <span class="badge">Last tested: ${pb.lastTested}</span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Readiness Checklist</div>
                <div class="card-subtitle">Before the next big incident.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Questions to answer</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Do we know who leads which scenario, by name, not title?</li>
                  <li>When was the last time we rehearsed with business and comms, not just security?</li>
                  <li>Do we have pre-approved comms templates for regulators, customers, and staff?</li>
                  <li>Have we run at least one cross-domain scenario (e.g., ransomware + OT impact)?</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMetrics() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Key Security Metrics</div>
                <div class="card-subtitle">Blend operational and executive views.</div>
              </div>
            </div>

            <div class="list">
              ${metrics
                .map(m => {
                  const statusClassName =
                    m.trend === 'improving'
                      ? 'ok'
                      : m.trend === 'steady'
                      ? 'warn'
                      : 'bad';
                  const label =
                    m.trend === 'improving'
                      ? 'Improving'
                      : m.trend === 'steady'
                      ? 'Flat'
                      : 'Needs attention';
                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${m.name}</strong></div>
                      <div class="badge-row">
                        <span class="badge chip">${m.value}</span>
                        <span class="badge">
                          <span class="tag-dot ${statusClassName}"></span>${label}
                        </span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Metric Design</div>
                <div class="card-subtitle">Avoid vanity metrics; aim for decisions.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Good metrics usually...</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Are tied to a capability (e.g., SIEM, IR, cloud security).</li>
                  <li>Lead to a decision if the number moves in the wrong direction.</li>
                  <li>Have a clearly defined owner and data source.</li>
                  <li>Are stable over time so you can show progress to executives.</li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
  }

  function renderTools() {
    const container = document.getElementById('view-container');

    const avgTc = toolCapabilities.length
      ? toolCapabilities.reduce((s, tc) => s + (Number(tc.currentMaturity) || 0), 0) / toolCapabilities.length
      : 0;

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Tools & Platforms</div>
                <div class="card-subtitle">Track what each tool can do (capabilities) and how mature each capability is (0–5).</div>
              </div>
              <div class="metric-pill"><span class="tag-dot"></span>${tools.length} tools</div>
            </div>

            <div class="section-note">
              A tool doesn’t have one maturity score. Each tool has multiple capabilities, and each capability can mature independently.
            </div>

            <div class="list">
              ${tools.map(tool => {
                const rows = toolCapabilities.filter(tc => tc.toolId === tool.id);
                const rowsAvg = rows.length
                  ? (rows.reduce((s, r) => s + (Number(r.currentMaturity) || 0), 0) / rows.length).toFixed(1)
                  : '0.0';

                const lastReviewed = rows.map(r => r.lastReviewed).filter(Boolean).sort().slice(-1)[0] || '—';

                return `
                  <div class="detail-panel" style="margin-top:10px; cursor:default;">
                    <div class="detail-title">${tool.name}</div>
                    <div class="detail-domain">${tool.vendor || 'Vendor'} · ${tool.category || 'Category'}</div>

                    <div class="chips-row">
                      <span class="chip-pill em">Avg capability maturity: ${rowsAvg} / 5</span>
                      <span class="chip-pill">Capabilities: ${rows.length}</span>
                      <span class="chip-pill">Last reviewed: ${lastReviewed}</span>
                    </div>

                    ${tool.notes ? `<div class="detail-body" style="margin-top:6px;">${escapeHtml(tool.notes)}</div>` : ''}

                    <div class="action-row">
                      <button type="button" class="action-link tool-edit" data-tool-id="${tool.id}">Edit</button>
                      <button type="button" class="action-link danger tool-delete" data-tool-id="${tool.id}">Delete</button>
                    </div>

                    <div style="margin-top:10px;">
                      <div class="section-title">Capabilities in this tool</div>

                      <div class="list">
                        ${rows.length ? rows.map(r => {
                          const cap = capabilities.find(c => c.id === r.capabilityId);
                          const capName = cap ? cap.name : r.capabilityId;
                          return `
                            <div class="list-item" style="cursor:default">
                              <div><strong>${capName}</strong></div>
                              <div class="section-note">${cap ? cap.domain : ''}</div>

                              <div class="badge-row">
                                <span class="badge chip cap-maturity-pill" data-tc-id="${r.id}" title="Click to cycle 0→5">
                                  <span class="tag-dot ${Number(r.currentMaturity) >= Number(r.targetMaturity || 3) ? '' : (Number(r.targetMaturity || 3) - Number(r.currentMaturity || 0) === 1 ? 'warn' : 'bad')}"></span>
                                  Maturity ${Number(r.currentMaturity || 0)} / 5 · Target ${Number(r.targetMaturity || 3)}
                                </span>
                                <span class="badge">Reviewed: ${r.lastReviewed || '—'}</span>
                              </div>

                              <div class="section-note" style="margin-top:6px;">Notes</div>
                              <textarea class="textarea-input tc-notes" data-tc-id="${r.id}" rows="2" placeholder="Evidence / what’s missing / next steps...">${escapeHtml(r.notes || '')}</textarea>

                              <div class="action-row">
                                <button type="button" class="action-link tc-set-target" data-tc-id="${r.id}">Set target</button>
                                <button type="button" class="action-link danger tc-remove" data-tc-id="${r.id}">Remove</button>
                              </div>
                            </div>
                          `;
                        }).join('') : `<div class="section-note">No capabilities mapped yet. Add one below.</div>`}
                      </div>

                      <div class="detail-panel" style="margin-top:10px;">
                        <div class="detail-title">Add capability to this tool</div>
                        <div class="form-row">
                          <select class="select-input tc-add-cap" data-tool-id="${tool.id}">
                            ${capabilities.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                          </select>
                          <button class="mini-btn tc-add-btn" data-tool-id="${tool.id}">Add</button>
                        </div>
                        <div class="section-note" style="margin-top:6px;">
                          This creates a Tool × Capability row you can mature over time.
                        </div>
                      </div>

                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="detail-panel" style="margin-top:12px;">
              <div class="detail-title">Add Tool</div>
              <div class="detail-body">
                <button class="primary-btn" id="add-tool-btn" type="button">Add Tool</button>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Summary</div>
                <div class="card-subtitle">Program-level tool capability maturity.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">At a glance</div>
              <div class="grid-2">
                <div class="pill-stat">
                  <span class="pill-stat-label">Mapped tool-capabilities</span>
                  <span class="pill-stat-value">${toolCapabilities.length}</span>
                </div>
                <div class="pill-stat">
                  <span class="pill-stat-label">Avg maturity</span>
                  <span class="pill-stat-value ${avgTc >= 3 ? 'ok' : avgTc >= 2 ? 'warn' : 'bad'}">${avgTc.toFixed(1)} / 5</span>
                </div>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">How to use this</div>
                <div class="detail-body">
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>Map 3–5 capabilities for each major platform first.</li>
                    <li>Set maturity based on real usage (process + people + tuning), not license count.</li>
                    <li>Pick 1–2 uplift targets per quarter and push them +1 maturity.</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    `;

    // tool edit/delete
    container.querySelectorAll('.tool-edit').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); editTool(btn.dataset.toolId); });
    });
    container.querySelectorAll('.tool-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const tool = tools.find(t => t.id === btn.dataset.toolId);
        if (!tool) return;
        openModal({
          title: 'Delete Tool',
          subtitle: 'This also removes all Tool × Capability mappings for it.',
          bodyHtml: `<div class="detail-panel"><div class="detail-title">${escapeHtml(tool.name)}</div><div class="detail-body">Are you sure?</div></div>`,
          actions: [
            { label: 'Cancel', className: 'btn', onClick: closeModal },
            { label: 'Delete', className: 'btn danger', onClick: () => {
                tools = tools.filter(t => t.id !== tool.id);
                toolCapabilities = toolCapabilities.filter(tc => tc.toolId !== tool.id);
                saveState();
                closeModal();
                renderView('tools');
              }}
          ]
        });
      });
    });

    // add tool button (modal)
    const addBtn = container.querySelector('#add-tool-btn');
    addBtn?.addEventListener('click', () => {
      openFormModal({
        title: 'Add Tool / App',
        subtitle: 'Add a platform you already own. Map capabilities next.',
        fields: [
          { name: 'name', label: 'Tool Name', type: 'text', required: true, full: true },
          { name: 'vendor', label: 'Vendor', type: 'text', required: true },
          { name: 'category', label: 'Category', type: 'text', required: true },
          { name: 'notes', label: 'Notes', type: 'textarea', rows: 3, full: true }
        ],
        initial: { name:'', vendor:'', category:'', notes:'' },
        saveLabel: 'Add',
        onSave: (d) => {
          tools.push({
            id: 'tool_custom_' + Date.now(),
            name: String(d.name).trim(),
            vendor: String(d.vendor).trim(),
            category: String(d.category).trim(),
            notes: d.notes || ''
          });
          saveState();
          renderView('tools');
        }
      });
    });

    // Add capability to tool
    container.querySelectorAll('.tc-add-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const toolId = btn.dataset.toolId;
        const sel = container.querySelector(`.tc-add-cap[data-tool-id="${toolId}"]`);
        const capId = sel?.value;
        if (!capId) return;
        ensureToolCapability(toolId, capId);
        renderView('tools');
      });
    });

    // Cycle maturity
    container.querySelectorAll('.cap-maturity-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        cycleToolCapMaturity(pill.dataset.tcId);
        renderView('tools');
      });
    });

    // Notes update
    container.querySelectorAll('.tc-notes').forEach(area => {
      area.addEventListener('change', () => {
        const tc = toolCapabilities.find(x => x.id === area.dataset.tcId);
        if (!tc) return;
        tc.notes = area.value;
        tc.lastReviewed = new Date().toISOString().slice(0, 10);
        saveState();
      });
    });

    // Set target
    container.querySelectorAll('.tc-set-target').forEach(btn => {
      btn.addEventListener('click', () => {
        const tc = toolCapabilities.find(x => x.id === btn.dataset.tcId);
        if (!tc) return;
        openFormModal({
          title: 'Set Target Maturity',
          subtitle: 'Target maturity for this tool capability (0–5).',
          fields: [
            { name: 'targetMaturity', label: 'Target (0–5)', type: 'number', min: 0, max: 5, step: 1, required: true, full: true }
          ],
          initial: { targetMaturity: Number(tc.targetMaturity ?? 3) },
          onSave: (d) => {
            const n = Number(d.targetMaturity);
            if (Number.isNaN(n) || n < 0 || n > 5) return;
            tc.targetMaturity = n;
            tc.lastReviewed = new Date().toISOString().slice(0, 10);
            saveState();
            renderView('tools');
          }
        });
      });
    });

    // Remove mapping
    container.querySelectorAll('.tc-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        const tc = toolCapabilities.find(x => x.id === btn.dataset.tcId);
        if (!tc) return;
        const capName = capabilities.find(c => c.id === tc.capabilityId)?.name || tc.capabilityId;
        const toolName = tools.find(t => t.id === tc.toolId)?.name || tc.toolId;
        openModal({
          title: 'Remove Capability Mapping',
          subtitle: `${toolName} → ${capName}`,
          bodyHtml: `<div class="detail-panel"><div class="detail-body">Remove this capability from this tool?</div></div>`,
          actions: [
            { label: 'Cancel', className: 'btn', onClick: closeModal },
            { label: 'Remove', className: 'btn danger', onClick: () => {
                removeToolCapabilityRow(btn.dataset.tcId);
                closeModal();
                renderView('tools');
              } }
          ]
        });
      });
    });
  }


  
  function renderHeatmap() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Tool Capability Heatmap</div>
                <div class="card-subtitle">Cell = maturity (0–5) for Tool × Capability. Click a cell to jump to that tool.</div>
              </div>
            </div>

            <div class="section-note">
              Missing cells mean the capability hasn’t been mapped to that tool yet. Map it in <strong>Tools & Platforms</strong>.
            </div>

            <div class="heatmap-wrapper">
              <table class="heatmap">
                <thead>
                  <tr>
                    <th>Capability</th>
                    ${tools.map(t => `<th class="hm-tool-header" data-tool-id="${t.id}" title="${escapeHtml(t.vendor || '')} • ${escapeHtml(t.category || '')}
Click to open tool">${escapeHtml(t.name)}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${capabilities.map(cap => `
                    <tr>
                      <td class="hm-cap-row" data-cap-id="${cap.id}" title="Click to open capability">${escapeHtml(cap.name)}</td>
                      ${tools.map(tool => {
                        const row = tcKey(tool.id, cap.id);
                        const lvl = row ? Number(row.currentMaturity || 0) : 0;
                        const cls = row ? hmClass(lvl) : 'hm0';
                        const label = row ? `L${lvl}` : '';
                        const title = `${tool.name} × ${cap.name}` + (row ? `
Maturity ${lvl}/5 (Target ${row.targetMaturity ?? 3})` : `
Not mapped yet`);
                        return `<td class="${cls} hm-cell" data-tool-id="${tool.id}" data-cap-id="${cap.id}" title="${escapeHtml(title)}">${label}</td>`;

    // Drilldowns: headers + cells
    container.querySelectorAll('.hm-tool-header').forEach(th => {
      th.addEventListener('click', () => {
        renderView('tools', th.getAttribute('data-tool-id'));
      });
    });

    container.querySelectorAll('.hm-cap-row').forEach(td => {
      td.addEventListener('click', () => {
        renderView('capabilities', td.getAttribute('data-cap-id'));
      });
    });

    container.querySelectorAll('.hm-cell').forEach(td => {
      td.addEventListener('click', () => {
        const toolId = td.getAttribute('data-tool-id');
        const capId = td.getAttribute('data-cap-id');
        if (!toolId || !capId) return;

        // If not mapped yet, create mapping and offer uplift task.
        const row = tcKey(toolId, capId);
        if (!row) {
          ensureToolCapability(toolId, capId);
          saveState();
        }

        openToolCapabilityModal(toolId, capId);
      });
    });
                      }).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div class="section-note" style="margin-top:10px;">
              Tip: use this to find under-used capabilities before buying anything new.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Legend</div>
                <div class="card-subtitle">0–5 maturity scale.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Meaning</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li><span class="badge hm0" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 0 – unused/disabled</li>
                  <li><span class="badge hm1" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 1 – basic/ad-hoc</li>
                  <li><span class="badge hm2" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 2 – repeatable but informal</li>
                  <li><span class="badge hm3" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 3 – defined & documented</li>
                  <li><span class="badge hm4" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 4 – measured & managed</li>
                  <li><span class="badge hm5" style="border:none;">&nbsp;&nbsp;&nbsp;</span> 5 – optimized</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">What to do next</div>
                <div class="detail-body">
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>Pick a critical capability with mostly low cells.</li>
                    <li>Choose one platform to uplift by +1 maturity this quarter.</li>
                    <li>Create 1–3 tasks and tie them to a project.</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    `;

    container.querySelectorAll('.hm-cell').forEach(td => {
      td.addEventListener('click', () => {
        const toolId = td.dataset.toolId;
        renderView('tools', toolId);
        // scroll to tool panel
        setTimeout(() => {
          const el = document.querySelector(`[data-tool-id="${toolId}"]`);
          el?.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
        }, 50);
      });
    });
  }


  function renderSkills() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Team Skills Matrix</div>
                <div class="card-subtitle">Coverage across critical domains.</div>
              </div>
            </div>

            <div class="list">
              ${skills
                .map(s => {
                  const gap = s.target - s.level;
                  const className =
                    gap <= 0 ? 'ok' : gap === 1 ? 'warn' : 'bad';
                  const label =
                    gap <= 0
                      ? 'Target met'
                      : gap === 1
                      ? 'Near target'
                      : 'Needs uplift';

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${s.person}</strong> — ${s.skill}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          Level ${s.level} / ${s.target}
                        </span>
                        <span class="badge">
                          <span class="tag-dot ${className}"></span>${label}
                        </span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Coverage Highlights</div>
                <div class="card-subtitle">Where to invest training and hiring.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Gaps worth watching</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>AI / GenAI strategy and guardrails.</li>
                  <li>OT / ICS security depth for critical environments.</li>
                  <li>Cloud security engineering, especially for multi-cloud.</li>
                  <li>Crisis communications and cross-business incident leadership.</li>
                </ul>
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">Actions</div>
                <div class="list">
                  <div class="list-item" style="cursor:default">
                    <div>Turn the biggest skill gaps into targeted learning paths or hiring plans.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Pair junior staff with senior leads via structured shadowing in IR, threat detection, and cloud.</div>
                  </div>
                  <div class="list-item" style="cursor:default">
                    <div>Run a quarterly skills review alongside your maturity assessment.</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderIR() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">IR Playbooks</div>
                <div class="card-subtitle">Key scenarios and their test cadence.</div>
              </div>
            </div>

            <div class="list">
              ${irPlaybooks
                .map(pb => {
                  const statusClassName =
                    pb.status === 'Healthy'
                      ? 'ok'
                      : pb.status === 'Needs Retest'
                      ? 'warn'
                      : 'bad';

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${pb.name}</strong></div>
                      <div class="section-note">Owner: ${pb.owner}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          <span class="tag-dot ${statusClassName}"></span>${pb.status}
                        </span>
                        <span class="badge">Last tested: ${pb.lastTested}</span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Readiness Checklist</div>
                <div class="card-subtitle">Before the next big incident.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Questions to answer</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Do we know who leads which scenario, by name, not title?</li>
                  <li>When was the last time we rehearsed with business and comms, not just security?</li>
                  <li>Do we have pre-approved comms templates for regulators, customers, and staff?</li>
                  <li>Have we run at least one cross-domain scenario (e.g., ransomware + OT impact)?</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMetrics() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Key Security Metrics</div>
                <div class="card-subtitle">Blend operational and executive views.</div>
              </div>
            </div>

            <div class="list">
              ${metrics
                .map(m => {
                  const statusClassName =
                    m.trend === 'improving'
                      ? 'ok'
                      : m.trend === 'steady'
                      ? 'warn'
                      : 'bad';
                  const label =
                    m.trend === 'improving'
                      ? 'Improving'
                      : m.trend === 'steady'
                      ? 'Flat'
                      : 'Needs attention';
                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${m.name}</strong></div>
                      <div class="badge-row">
                        <span class="badge chip">${m.value}</span>
                        <span class="badge">
                          <span class="tag-dot ${statusClassName}"></span>${label}
                        </span>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Metric Design</div>
                <div class="card-subtitle">Avoid vanity metrics; aim for decisions.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Good metrics usually...</div>
              <div class="detail-body">
                <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                  <li>Are tied to a capability (e.g., SIEM, IR, cloud security).</li>
                  <li>Lead to a decision if the number moves in the wrong direction.</li>
                  <li>Have a clearly defined owner and data source.</li>
                  <li>Are stable over time so you can show progress to executives.</li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
  }

  function renderProjects() {
    const container = document.getElementById('view-container');

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Project Portfolio</div>
                <div class="card-subtitle">Epics that move capability maturity.</div>
              </div>
              <div class="metric-pill">
                <span class="tag-dot"></span>
                ${projects.length} projects
              </div>
            </div>

            <div class="section-note">
              Each project ties to a capability and set of tasks. As tasks move to Done, project progress updates automatically.
            </div>

            <div class="list">
              ${projects
                .map(p => {
                  const cap = capabilities.find(c => c.id === p.capabilityId);
                  const capName = cap ? cap.name : p.capabilityId;
                  const status = getProjectStatus(p);
                  const prog = getProjectProgress(p);
                  const projected = cap ? projectedMaturity(cap) : null;

                  const statusClassName =
                    status === 'Complete'
                      ? 'ok'
                      : status === 'Blocked'
                      ? 'bad'
                      : status === 'Active'
                      ? 'warn'
                      : '';

                  return `
                    <div class="list-item" style="cursor:default">
                      <div><strong>${p.name}</strong></div>
                      <div class="section-note">${capName} · Owner: ${p.owner}</div>
                      <div class="badge-row">
                        <span class="badge chip">
                          <span class="tag-dot ${statusClassName}"></span>${status}
                        </span>
                        <span class="badge">
                          ${prog.done} / ${prog.total || 0} tasks · ${prog.percent}%
                        </span>
                        ${
                          projected != null && cap
                            ? `<span class="badge">Maturity: ${cap.maturity} → ${projected}</span>`
                            : ''
                        }
                        <span class="badge">Timeline: ${p.start} → ${p.target}</span>
                      </div>
                      ${
                        p.notes
                          ? `<div class="section-note" style="margin-top:4px;">${p.notes}</div>`
                          : ''
                      }
                      <div style="margin-top:6px; width:100%; background:rgba(15,23,42,0.95); border-radius:999px; border:1px solid rgba(31,41,55,0.9); overflow:hidden;">
                        <div style="height:6px; width:${prog.percent}%; max-width:100%; background:linear-gradient(to right,#0ea5e9,#22c55e);"></div>
                      </div>
                      <div class="action-row">
                        <button type="button" class="action-link project-edit" data-project-id="${p.id}">Edit</button>
                        <button type="button" class="action-link danger project-delete" data-project-id="${p.id}">Delete</button>
                      </div>
                    </div>
                  `;
                })
                .join('')}
            </div>

            <div class="detail-panel" style="margin-top:12px;">
              <div class="detail-title">Add Project</div>
              <div class="detail-body">
                <form id="add-project-form">
                  <div class="form-row">
                    <input class="form-input" name="name" placeholder="Project name (e.g., Threat Detection 2.0)" />
                  </div>
                  <div class="form-row">
                    <select class="select-input" name="capabilityId">
                      ${capabilities
                        .map(cap => `<option value="${cap.id}">${cap.name}</option>`)
                        .join('')}
                    </select>
                    <input class="form-input" name="owner" placeholder="Owner (e.g., SOC Lead)" />
                  </div>
                  <div class="form-row">
                    <input class="form-input" name="start" placeholder="Start date (YYYY-MM-DD)" />
                    <input class="form-input" name="target" placeholder="Target date (YYYY-MM-DD)" />
                    <input class="form-input" name="impact" placeholder="Maturity impact (e.g., 1 or 2)" />
                  </div>
                  <div class="section-note" style="margin-top:6px;">Link tasks to this project:</div>
                  <div class="chips-row" style="max-height:120px; overflow:auto; padding:4px 0;">
                    ${tasks
                      .map(
                        t => `
                          <label class="chip-pill">
                            <input type="checkbox" name="taskId" value="${t.id}" style="margin-right:4px;" />
                            ${t.title}
                          </label>
                        `
                      )
                      .join('')}
                  </div>
                  <button type="submit" class="primary-btn">Add Project</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Timeline & Maturity</div>
                <div class="card-subtitle">Rough view of when projects land and what they move.</div>
              </div>
            </div>

            <div class="detail-panel">
              <div class="detail-title">Project Timeline (simple)</div>
              <div class="detail-body">
                ${
                  !projects.length
                    ? '<div class="section-note">No projects yet. Add one on the left.</div>'
                    : projects
                        .map(p => {
                          const status = getProjectStatus(p);
                          const statusClassName =
                            status === 'Complete'
                              ? 'ok'
                              : status === 'Blocked'
                              ? 'bad'
                              : status === 'Active'
                              ? 'warn'
                              : '';
                          return `
                            <div style="margin-top:6px;">
                              <div style="font-size:0.8rem; color:var(--muted); margin-bottom:2px;">
                                <strong>${p.name}</strong> · <span class="tag-dot ${statusClassName}"></span>${status}
                              </div>
                              <div style="height:10px; border-radius:999px; background:rgba(15,23,42,0.95); border:1px solid rgba(31,41,55,0.9); overflow:hidden;">
                                <div style="height:100%; width:70%; background:linear-gradient(to right,#0ea5e9,#6366f1);"></div>
                              </div>
                              <div style="font-size:0.7rem; color:var(--muted); margin-top:2px;">
                                ${p.start} → ${p.target}
                              </div>
                            </div>
                          `;
                        })
                        .join('')
                }
              </div>

              <div style="margin-top:10px;">
                <div class="section-title">How this helps you</div>
                <div class="detail-body">
                  <ul style="margin:6px 0 0 18px; padding:0; font-size:0.86rem;">
                    <li>Group your tasks into 2–5 named projects instead of dozens of one-offs.</li>
                    <li>Use project maturity impact to show leadership how work ties to capabilities.</li>
                    <li>You don&apos;t need ServiceNow: this is your lightweight, local project board.</li>
                    <li>If you <em>do</em> have ServiceNow, you can mirror projects/epics there but keep this app as your security-specific lens.</li>
                  </ul>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    `;

    const addProjectForm = container.querySelector('#add-project-form');
    if (addProjectForm) {
      addProjectForm.addEventListener('submit', e => {
        e.preventDefault();
        const fd = new FormData(addProjectForm);

        const name = (fd.get('name') || '').trim();
        if (!name) return;

        const capabilityId = fd.get('capabilityId') || capabilities[0]?.id || 'governance';
        const owner = (fd.get('owner') || '').trim() || 'Unassigned';
        const start = (fd.get('start') || '').trim() || '2025-01-01';
        const target = (fd.get('target') || '').trim() || '2025-12-31';
        const impact = parseInt(fd.get('impact') || '1', 10) || 1;
        const taskIds = fd.getAll('taskId');

        const newProj = {
          id: 'proj_custom_' + Date.now(),
          name,
          capabilityId,
          owner,
          start,
          target,
          maturityImpact: impact,
          taskIds,
          notes: ''
        };

        projects.push(newProj);
        saveState();
        renderView('projects');
      });
    }

    wireProjectCrudHandlers(container);
  }

  // ---------- Shared wiring helpers ------------------

  function wireTaskStatusClickHandlers(rootEl) {
    rootEl.querySelectorAll('.task-status').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-task-id');
        cycleStatus(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'overview';
        renderView(currentView);
      });
    });
  }

  function wireTaskCrudHandlers(rootEl) {
    rootEl.querySelectorAll('.task-edit').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-task-id');
        editTask(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'overview';
        renderView(currentView);
      });
    });
    rootEl.querySelectorAll('.task-delete').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-task-id');
        deleteTask(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'overview';
        renderView(currentView);
      });
    });
  }

  function wireToolLevelClickHandlers(rootEl) {
    rootEl.querySelectorAll('.tool-level').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-tool-id');
        cycleToolLevel(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'tools';
        renderView(currentView);
      });
    });
  }

  function wireToolCrudHandlers(rootEl) {
    rootEl.querySelectorAll('.tool-edit').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-tool-id');
        editTool(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'tools';
        renderView(currentView);
      });
    });
    rootEl.querySelectorAll('.tool-delete').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-tool-id');
        deleteTool(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'tools';
        renderView(currentView);
      });
    });
  }

  function wireProjectCrudHandlers(rootEl) {
    rootEl.querySelectorAll('.project-edit').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-project-id');
        editProject(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'projects';
        renderView(currentView);
      });
    });
    rootEl.querySelectorAll('.project-delete').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        const id = el.getAttribute('data-project-id');
        deleteProject(id);
        const currentView =
          document.querySelector('.nav-item.active')?.dataset.view || 'projects';
        renderView(currentView);
      });
    });
  }

  let currentView = 'overview';
  let currentSelectedId = null;

  function renderView(viewKey, extra) {
    currentView = viewKey;
    currentSelectedId = extra || null;
    setHeader(viewKey);
    switch (viewKey) {
      case 'overview':
        renderOverview();
        break;
      case 'guided':
        renderGuidedPlan();
        break;
      case 'capabilities':
        renderCapabilities(extra);
        break;
      case 'maturity':
        renderMaturity();
        break;
      case 'projects':
        renderProjects();
        break;
      case 'roadmap':
        renderRoadmap();
        break;
      case 'tools':
        renderTools();
        break;
      case 'heatmap':
        renderHeatmap();
        break;
      case 'skills':
        renderSkills();
        break;
      case 'ir':
        renderIR();
        break;
      case 'metrics':
        renderMetrics();
        break;
      default:
        renderOverview();
    }
  }

  // ---------- Nav wiring + initial render ------------------

  document.querySelectorAll('.nav-item').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      renderView(view);
    });
  });

  renderView('overview');

</script>


  <!-- Modal -->
  <div id="modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modal-title">Edit</div>
          <div class="modal-subtitle" id="modal-subtitle"></div>
        </div>
        <button class="modal-close" id="modal-close" aria-label="Close">✕</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-actions" id="modal-actions"></div>
    </div>
  </div>

</body>
</html>
